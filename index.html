<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explore Nepal ‚Äì Tourist Guide</title>
  <meta name="description" content="Explore Nepal ‚Äî guide to mountains, lakes, parks, temples, tours, and travel tips." />
  <meta name="theme-color" content="#0b67d0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <!-- Leaflet + MarkerCluster + Controls -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+qJb2zP0rVqjQv3Tq+Eo1t6S1VnKk6b5nYkGxkNDs=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --primary:#0b67d0; --accent:#ff8c42; --muted:#6b7280; --glass:rgba(255,255,255,0.6);
      --radius:14px; --shadow-soft: 0 8px 30px rgba(8,15,30,0.06); --shadow-strong: 0 24px 60px rgba(2,6,23,0.15);
      --glass-border: rgba(11,103,208,0.08);
      --success:#16a34a; --danger:#ef4444; --glass-blur:10px;
      --max-width:1200px;
    }
    [data-theme="dark"]{
      --bg:#071226; --card:#081425; --muted:#9aa4b2; --primary:#3ea0ff; color:#eaf4ff; --glass:rgba(10,18,28,0.6); --glass-border: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#fff);-webkit-font-smoothing:antialiased}
    a{color:inherit}
    .container{max-width:var(--max-width);margin:0 auto;padding:20px}

    /* Header */
    header.site-header{position:sticky;top:0;z-index:220;background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff;padding:10px 0;backdrop-filter:blur(6px)}
    .header-inner{display:flex;align-items:center;gap:14px;padding:8px 20px}
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
    .brand img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.12)}
    .brand h1{margin:0;font-size:1.05rem;font-weight:800;letter-spacing:0.2px}
    nav.main-nav{margin-left:auto;display:flex;gap:12px;align-items:center}
    nav.main-nav a{color:rgba(255,255,255,0.98);text-decoration:none;font-weight:700;padding:8px 12px;border-radius:10px;transition:background .18s,transform .12s}
    nav.main-nav a:hover{background:rgba(255,255,255,0.06);transform:translateY(-2px)}
    .search{margin-left:16px;position:relative}
    .search input{padding:10px 14px;border-radius:999px;border:none;width:300px;outline:none;box-shadow:var(--shadow-soft)}
    .mobile-toggle{display:none;background:transparent;border:none;color:#fff;font-size:1.2rem}

    /* Hero */
    .hero{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:center;margin:22px 0;position:relative;overflow:visible}
    .hero-card{background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9));padding:34px;border-radius:18px;box-shadow:var(--shadow-strong);border:1px solid rgba(18,38,63,0.04);transition:transform .18s}
    [data-theme="dark"] .hero-card{background:linear-gradient(180deg,rgba(10,18,28,0.92),rgba(6,12,22,0.95));border:1px solid rgba(255,255,255,0.03)}
    .hero-card:hover{transform:translateY(-6px)}
    .hero h2{margin:0 0 8px 0;font-size:1.9rem;line-height:1.05}
    .hero p{margin:0 0 14px 0;color:var(--muted);font-size:1rem}
    .cta-row{display:flex;gap:10px}
    .btn{background:var(--primary);color:#fff;padding:11px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:800;box-shadow:0 8px 24px rgba(11,103,208,0.12);transition:transform .15s,box-shadow .15s}
    .btn:hover{transform:translateY(-3px)}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(255,255,255,0.12);box-shadow:none}
    .btn.small{padding:8px 10px;font-size:.9rem;border-radius:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fff,#fbfdff);box-shadow:var(--shadow-soft);font-weight:700}

    .hero-decor { position:absolute; right: -40px; top: -40px; width:420px; height:420px; pointer-events:none; filter:blur(32px); opacity:0.18; mix-blend-mode:screen; }
    @keyframes floaty { 0%{transform:translateY(0) rotate(0);}50%{transform:translateY(-12px) rotate(3deg);}100%{transform:translateY(0) rotate(0);} }

    /* Controls */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0;justify-content:center}
    .filter-btns{display:flex;gap:8px;flex-wrap:wrap}
    .filter-btns button{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,36,0.06);background:#fff;cursor:pointer;font-weight:700;transition:transform .12s}
    .filter-btns button.active{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(255,140,66,0.12)}
    .sort-select{padding:8px;border-radius:10px;border:1px solid rgba(15,23,36,0.06);background:#fff}

    /* Grid & cards */
    .destinations{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .card{background:var(--card);border-radius:14px;border:1px solid rgba(12,20,30,0.04);overflow:hidden;display:flex;flex-direction:column;transition:transform .25s,box-shadow .25s;box-shadow:var(--shadow-soft)}
    .card.revealed{transform:translateY(0) scale(1); opacity:1}
    .card.hidden{transform:translateY(20px) scale(.98); opacity:0;filter:blur(.6px)}
    .card:hover{transform:translateY(-10px) scale(1.02); box-shadow:0 30px 70px rgba(8,15,30,0.12)}
    .media{height:180px;position:relative;overflow:hidden;background:linear-gradient(180deg,#e6f0ff,#fff)}
    .media img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .6s cubic-bezier(.2,.9,.2,1)}
    .card:hover .media img{transform:scale(1.08) translateY(-4px)}
    .card .info{padding:14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .rating{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.9));padding:6px 8px;border-radius:999px;font-weight:800}

    /* Map */
    .map-controls{display:flex;gap:8px;align-items:center}
    .map-legend{background:var(--card);padding:8px;border-radius:10px;box-shadow:var(--shadow-soft);border:1px solid rgba(12,20,30,0.04);font-size:.9rem}

    /* Chat */
    #chat-box{position:fixed;right:22px;bottom:22px;width:360px;background:transparent;border-radius:16px;overflow:visible;z-index:16000;transition:transform .18s}
    #chat-panel{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:14px;overflow:hidden;border:1px solid rgba(12,20,30,0.06);box-shadow:var(--shadow-strong);display:flex;flex-direction:column;max-height:80vh}
    #chat-header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff;cursor:pointer;font-weight:800;user-select:none}
    #chat-header .avatar{width:36px;height:36px;border-radius:10px;overflow:hidden;background:rgba(255,255,255,0.12);display:inline-flex;align-items:center;justify-content:center;font-weight:800}
    #chat-messages{padding:14px;height:320px;overflow:auto;font-size:0.95rem;background:linear-gradient(180deg,rgba(250,252,255,0.9),transparent)}
    .msg{margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
    .msg.user{flex-direction:row-reverse}
    .msg .bubble{max-width:78%;padding:10px 12px;border-radius:12px;background:#f1f5f9;color:#0f1724;box-shadow:0 6px 20px rgba(8,15,30,0.04);position:relative;animation:pop .16s ease}
    .msg.user .bubble{background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff}
    .avatar-mini{width:34px;height:34px;border-radius:8px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-weight:700;background:rgba(0,0,0,0.06)}
    .msg .time {display:block;font-size:.72rem;color:var(--muted);margin-top:6px;opacity:.85}
    .typing{display:inline-block;width:56px;height:18px;border-radius:12px;background:rgba(0,0,0,0.06);position:relative}
    .typing::before,.typing::after{content:'';position:absolute;left:8px;top:6px;width:6px;height:6px;border-radius:50%;background:#cbd5e1;animation:blink 1.2s infinite}
    .typing::after{left:22px;animation-delay:.2s}
    @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    @keyframes pop{0%{transform:scale(.98)}100%{transform:scale(1)}}

    #chat-input{display:flex;border-top:1px solid rgba(12,20,30,0.04);gap:8px;padding:10px}
    #chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(12,20,30,0.06);outline:none}
    #chat-input button{padding:10px 12px;border:none;background:var(--accent);color:#fff;border-radius:10px;cursor:pointer}
    .chat-suggests{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow-soft);font-weight:700}
    .chip:hover{transform:translateY(-3px)}

    #chat-panel.minimized{width:56px;height:56px;border-radius:999px;overflow:hidden}
    #chat-panel.minimized #chat-messages, #chat-panel.minimized #chat-input { display:none; }
    #chat-panel.minimized #chat-header{border-radius:999px;padding:12px}

    footer{background:#061026;color:#fff;padding:18px;text-align:center;margin-top:28px;border-radius:8px;box-shadow:var(--shadow-soft)}
    .credits{font-size:.9rem;color:rgba(255,255,255,0.8)}

    /* responsiveness */
    @media (max-width:980px){ .hero{grid-template-columns:1fr} .search input{width:160px} .hero-decor{display:none} }
    @media (max-width:720px){
      nav.main-nav{display:none}
      .mobile-toggle{display:inline-block}
      .search input{width:120px}
      #chat-box{right:12px;left:12px;width:auto}
      .hero{grid-template-columns:1fr}
    }

    .muted{color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Lightbox */
    .lightbox { position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:20000;opacity:0;pointer-events:none;transition:opacity .18s }
    .lightbox.open { opacity:1;pointer-events:auto }
    .lightbox img { max-width:92vw;max-height:86vh;border-radius:10px;box-shadow:0 30px 80px rgba(0,0,0,0.6) }

    /* Cookie banner */
    #cookie-banner { position:fixed;left:12px;right:12px;bottom:12px;background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow-strong);display:flex;gap:12px;align-items:center;z-index:20000 }
  </style>
</head>
<body data-theme="light" aria-busy="false">
  <header class="site-header" role="banner" aria-label="Top navigation">
    <div class="header-inner container">
      <div class="brand" onclick="location.href='#'">
        <img src="/images/logo.png" alt="Explore Nepal logo" onerror="this.style.display='none'">
        <h1 id="site-title">Explore Nepal üá≥üáµ</h1>
      </div>

      <button class="mobile-toggle" aria-label="Open menu" id="mobile-toggle">‚ò∞</button>

      <div class="search" role="search" aria-label="Search places">
        <input id="global-search" placeholder="Search places, e.g. Pokhara, Everest..." aria-label="Search places" autocomplete="off" />
        <div id="search-suggestions" role="listbox" aria-hidden="true" style="position:absolute;top:46px;left:0;background:var(--card);box-shadow:var(--shadow-soft);border-radius:10px;overflow:hidden;display:none;z-index:1200"></div>
      </div>

      <nav class="main-nav" aria-label="Main navigation">
        <a href="#about">About</a>
        <a href="#places">Places</a>
        <a href="#tours">Tours</a>
        <a href="#map">Map</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact</a>
      </nav>

      <div style="margin-left:12px;display:flex;gap:8px;align-items:center">
        <div id="lang-select" class="pill" title="Language selector" aria-label="Language selector"></div>
        <button id="theme-toggle" class="btn ghost" aria-pressed="false" title="Toggle theme">üåì</button>
        <button id="view-favs" class="btn ghost" title="View favorites">‚òÖ <span id="fav-count">0</span></button>
      </div>
    </div>
  </header>

  <main class="container" role="main" id="main">
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-h">
      <div class="hero-card" id="hero-card">
        <h2 id="hero-h">Plan your unforgettable trip to Nepal</h2>
        <p>Hand-picked places, verified photos, local tips, flexible itineraries and live weather. Start with curated destinations or create your own route.</p>
        <div class="cta-row">
          <button class="btn" id="start-explore">Explore top places</button>
          <button class="btn ghost" id="plan-trip">Create itinerary</button>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-size:.95rem">
          <strong>Pro Tip:</strong> Use the search and filters. Click "Details" for official photos, weather, reviews and booking.
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
          <div class="pill">Local-first ‚Ä¢ Offline-ready</div>
          <div class="pill" id="hero-cta-live">Live weather ‚Ä¢ <span id="hero-temp" class="muted">‚Äî</span></div>
        </div>
      </div>

      <aside style="display:flex;flex-direction:column;gap:12px" aria-hidden="false">
        <div class="widget" aria-live="polite" id="weather-widget">Loading weather‚Ä¶</div>
        <div class="widget" aria-label="Currency converter">
          <h4 style="margin:0 0 8px 0">Currency Converter</h4>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="cur-amount" type="number" value="1" style="padding:8px;width:80px">
            <select id="cur-from" style="padding:8px">
              <option value="USD">USD</option>
              <option value="NPR" selected>NPR</option>
              <option value="EUR">EUR</option>
              <option value="INR">INR</option>
            </select>
            <span>‚Üí</span>
            <select id="cur-to" style="padding:8px">
              <option value="NPR">NPR</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
            <button id="convert-btn" class="btn small">Convert</button>
          </div>
          <div id="convert-result" class="small" style="margin-top:8px;color:var(--muted)"></div>
        </div>
        <div class="widget" id="mini-itin-widget" style="padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
          <strong>Your itinerary</strong>
          <div id="mini-itin-list" style="margin-top:8px;color:var(--muted)">No items yet</div>
        </div>
      </aside>

      <div class="hero-decor" aria-hidden="true" style="animation:floaty 8s ease-in-out infinite">
        <svg viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#0b67d0"/><stop offset="1" stop-color="#0a8bf0"/></linearGradient>
          </defs>
          <g transform="translate(-80,-80)">
            <circle cx="300" cy="300" r="180" fill="url(#g1)" opacity="0.18"/>
            <rect x="200" y="90" width="220" height="220" rx="40" fill="#ff8c42" opacity="0.06"/>
          </g>
        </svg>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" aria-labelledby="about-h" style="margin-top:8px">
      <h2 id="about-h">Welcome to Nepal</h2>
      <p style="color:var(--muted)">Nepal is a land of dramatic landscapes, rich culture and incredible diversity. This guide helps tourists explore mountains, lakes, temples, parks and heritage sites in a privacy-first, offline-first approach. Search, filter, plan and save ‚Äî all locally. Add your photos to the /images/ folder to replace placeholders.</p>
    </section>

    <!-- CONTROLS -->
    <section style="margin-top:12px">
      <div class="controls" role="region" aria-label="Controls for the places list">
        <div class="filter-btns" role="toolbar" aria-label="Filter places">
          <button class="active" data-filter="all">All</button>
          <button data-filter="mountains">Mountains</button>
          <button data-filter="lakes">Lakes</button>
          <button data-filter="temples">Temples</button>
          <button data-filter="heritage">Heritage</button>
          <button data-filter="wildlife">Wildlife</button>
          <button data-filter="cultural">Cultural</button>
          <button data-filter="trek">Treks</button>
        </div>

        <select id="sort-by" class="sort-select" aria-label="Sort places">
          <option value="recommended">Recommended</option>
          <option value="rating-desc">Rating: High ‚Üí Low</option>
          <option value="rating-asc">Rating: Low ‚Üí High</option>
          <option value="alpha">A ‚Üí Z</option>
        </select>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="export-itin" class="btn ghost">Export itinerary</button>
          <button class="btn" id="open-map">Open interactive map</button>
        </div>
      </div>
    </section>

    <!-- PLACES GRID -->
    <section id="places" aria-labelledby="places-h" style="margin-top:8px">
      <h2 id="places-h">Top Tourist Places</h2>
      <div class="destinations" id="destinations" aria-live="polite" role="list"></div>
      <!-- We will generate many place cards via JS from a dataset so it's easier to maintain and larger lists are dynamic -->
    </section>

    <!-- MAP + WIDGETS -->
    <section id="map" aria-labelledby="map-h" style="margin-top:18px">
      <h2 id="map-h">Explore Nepal Map</h2>
      <div class="map-controls" style="margin-bottom:8px">
        <div class="map-legend" id="map-legend">Layers: <label><input type="checkbox" id="layer-mountains" checked> Mountains</label> <label><input type="checkbox" id="layer-lakes" checked> Lakes</label></div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="locate-me" class="btn small">Locate me</button>
          <button id="fit-itin" class="btn ghost small" title="Fit itinerary on map">Fit itinerary</button>
        </div>
      </div>
      <div class="map-container" id="map-frame" role="application" aria-label="Map of Nepal" style="height:560px;">
        <div id="leaflet-map" style="width:100%;height:100%"></div>
      </div>
      <div class="widgets" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="widget">
          <h4 style="margin:0 0 8px 0">Plan ahead</h4>
          <p class="small muted">Click a place's "Details" to see official photos, weather, reviews and easy booking. Use the search & filters to find places quickly. Drag places into your itinerary to build routes.</p>
        </div>
        <div class="widget">
          <h4 style="margin:0 0 8px 0">Nearby</h4>
          <p class="small muted">Use the "Locate me" feature to see attractions near your current location.</p>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="nearby-safari" class="btn ghost small">Nearby safaris</button>
          </div>
        </div>
        <div class="widget" id="map-stats">
          <h4 style="margin:0 0 8px 0">Map stats</h4>
          <p class="small muted" id="map-info">Loading...</p>
        </div>
      </div>
    </section>

    <!-- ITINERARY -->
    <section id="itinerary" aria-labelledby="itinerary-h" style="margin-top:18px">
      <h2 id="itinerary-h">My Itinerary</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;margin-bottom:12px">
        <div class="itinerary" id="itinerary-box" style="min-width:320px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">No items ‚Äî add places to build an itinerary.</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="itinerary" style="min-width:240px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
            <div style="font-weight:700">Actions</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="print-itin" class="btn">Print</button>
              <button id="share-itin" class="btn ghost">Share</button>
              <button id="clear-itin" class="btn ghost" title="Clear itinerary">Clear</button>
            </div>
          </div>
          <div class="itinerary" style="min-width:240px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
            <div style="font-weight:700">Export</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="export-json" class="btn ghost small">Export JSON</button>
              <button id="export-ics" class="btn ghost small">Export .ics</button>
              <button id="import-itin" class="btn ghost small">Import JSON</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" aria-labelledby="faq-h" style="margin-top:18px">
      <h2 id="faq-h">FAQ & Emergency</h2>
      <div style="max-width:900px;margin:0 auto">
        <details><summary>How do I get permits for trekking?</summary><p class="small muted">Popular treks require TIMS and national park permits; local agencies/trekking companies can assist with permits and porters.</p></details>
        <details><summary>What is the best time to visit?</summary><p class="small muted">Spring (Mar‚ÄìMay) and Autumn (Sep‚ÄìNov) are ideal for trekking and clear mountain views.</p></details>
        <details><summary>Emergency contacts</summary>
          <ul class="small muted">
            <li>Police (Nepal): 100</li>
            <li>Ambulance: 102</li>
            <li>Tourist Police (Kathmandu): +977-1-425xxxx (example)</li>
          </ul>
        </details>
      </div>
    </section>

    <!-- CONTACT / NEWSLETTER -->
    <section id="contact" aria-labelledby="contact-h" style="margin-top:18px">
      <h2 id="contact-h">Contact & Social Media</h2>
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px">
        <a href="https://www.facebook.com/sanjay.subedi.963" target="_blank" rel="noopener" title="Facebook">üìò</a>
        <a href="https://www.instagram.com/sanjaysubedi2063/?__pwa=1" target="_blank" rel="noopener" title="Instagram">üì∏</a>
        <a href="mailto:info@example.com" title="Email">‚úâÔ∏è</a>
      </div>

      <div style="max-width:640px;margin:12px auto;background:#fff;padding:12px;border-radius:8px;border:1px solid rgba(12,20,30,0.04)">
        <h4 style="margin-top:0">Newsletter</h4>
        <form id="newsletter">
          <input type="email" id="newsletter-email" placeholder="Your email" required style="padding:8px;width:65%"> <button class="btn" type="submit">Subscribe</button>
          <p class="small" id="newsletter-msg" style="margin:8px 0 0 0;color:var(--muted)"></p>
        </form>
      </div>
    </section>

  </main>

  <footer>
    <div class="credits">¬© 2026 Explore Nepal ‚Ä¢ Designed by Sanjay Subedi ‚Ä¢ Built with local-first data ‚Äî add your photos to /images/ for verified visuals.</div>
  </footer>

  <!-- CHAT -->
  <div id="chat-box" aria-live="polite" aria-label="Chat with guide">
    <div id="chat-panel">
      <div id="chat-header" role="button" aria-pressed="false" tabindex="0">
        <div class="avatar">GN</div>
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:800">Guide</div>
          <div class="status" id="chat-status">Online</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="voice-toggle" class="btn ghost small" title="Voice input">üé§</button>
          <button id="chat-minimize" class="btn ghost small" title="Toggle">‚àí</button>
        </div>
      </div>
      <div id="chat-messages" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div style="padding:10px">
        <div class="chat-suggests" id="chat-suggests" aria-hidden="false">
          <div class="chip" data-s="#suggest_weather">Weather in Pokhara</div>
          <div class="chip" data-s="#suggest_itin">Suggest itinerary</div>
          <div class="chip" data-s="#suggest_book">Book Everest trek</div>
        </div>
        <div id="chat-input">
          <input id="user-input" placeholder="Ask about places, weather or bookings..." aria-label="Chat input">
          <button id="send-btn" aria-label="Send message">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick menu / context -->
  <div id="quick-menu" style="display:none;position:fixed;z-index:17000;background:var(--card);border-radius:10px;padding:8px;border:1px solid rgba(12,20,30,0.06);box-shadow:var(--shadow-strong)"></div>

  <!-- Modal root -->
  <div id="modal-root" aria-hidden="true" style="display:none;"></div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true" onclick="closeLightbox()"><img id="lightbox-img" src="" alt="Photo"></div>

  <!-- Offline hint -->
  <div id="offline-banner" style="display:none;position:fixed;left:0;right:0;top:56px;background:#ffcc00;padding:8px;text-align:center;z-index:15000">You are offline ‚Äî some features may be limited.</div>

  <!-- Cookie / Consent -->
  <div id="cookie-banner" style="display:none" role="dialog" aria-live="polite">
    <div style="flex:1">
      We use local storage and optional analytics to improve the site. No external tracking by default. Accept local analytics to enable usage insights.
    </div>
    <div style="display:flex;gap:8px">
      <button id="cookie-accept" class="btn">Accept</button>
      <button id="cookie-decline" class="btn ghost">Decline</button>
    </div>
  </div>

  <!-- Service Worker Register + Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1jRk5kXQp4qf7wxiQq6l1YJQ/9tZK5QmQv5Y5rWk=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  (function () {
    'use strict';

    // --- Utilities ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function el(tag, props = {}, ...children) {
      const e = document.createElement(tag);
      for (const [k, v] of Object.entries(props)) {
        if (k.startsWith('on') && typeof v === 'function') {
          e.addEventListener(k.slice(2), v);
        } else if (k === 'class') {
          e.className = v;
        } else {
          e.setAttribute(k, String(v));
        }
      }
      for (const c of children) {
        if (c == null) continue;
        if (typeof c === 'string') e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      }
      return e;
    }

    // Simple privacy-aware analytics (local only until accepted)
    const analytics = {
      enabled: false,
      events: JSON.parse(localStorage.getItem('explore_analytics') || '[]'),
      track(name, props = {}) {
        if (!this.enabled) return;
        try {
          this.events.push({ name, props, time: new Date().toISOString() });
          localStorage.setItem('explore_analytics', JSON.stringify(this.events));
        } catch (e) { /* ignore */ }
      }
    };

    // Cookie / Consent UI
    const cookieBanner = $('#cookie-banner');
    function showCookie() {
      const seen = localStorage.getItem('explore_cookie_v1');
      if (!seen) cookieBanner.style.display = 'flex';
    }
    $('#cookie-accept').addEventListener('click', () => {
      analytics.enabled = true;
      localStorage.setItem('explore_cookie_v1', 'accepted');
      cookieBanner.style.display = 'none';
      analytics.track('cookie_accept');
    });
    $('#cookie-decline').addEventListener('click', () => {
      analytics.enabled = false;
      localStorage.setItem('explore_cookie_v1', 'declined');
      cookieBanner.style.display = 'none';
    });
    if (localStorage.getItem('explore_cookie_v1') === 'accepted') analytics.enabled = true;
    showCookie();

    // Theme
    const themeToggle = $('#theme-toggle');
    const initialTheme = localStorage.getItem('explore_theme') || 'light';
    document.body.setAttribute('data-theme', initialTheme);
    themeToggle.setAttribute('aria-pressed', String(initialTheme === 'dark'));
    themeToggle.addEventListener('click', () => {
      const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('explore_theme', theme);
      themeToggle.setAttribute('aria-pressed', String(theme === 'dark'));
      analytics.track('theme_toggle', { theme });
    });

    // Language selector
    const LANGS = { en: 'English', ne: '‡§®‡•á‡§™‡§æ‡§≤‡•Ä', hi: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', es: 'Espa√±ol', fr: 'Fran√ßais' };
    const langRoot = $('#lang-select');
    let currentLang = localStorage.getItem('explore_lang') || 'en';
    function renderLangs() {
      langRoot.innerHTML = '';
      Object.entries(LANGS).forEach(([code, label]) => {
        const b = el('button', { title: label, type: 'button', onClick: () => setLang(code) }, label);
        b.style.fontWeight = code === currentLang ? '800' : '600';
        b.style.background = 'transparent';
        b.style.border = 'none';
        b.style.color = 'inherit';
        langRoot.appendChild(b);
      });
    }
    function setLang(code) {
      currentLang = code;
      localStorage.setItem('explore_lang', code);
      renderLangs();
      analytics.track('lang_change', { lang: code });
      // translations: left as exercise (localization skeleton)
    }
    renderLangs();

    // Intersection reveal
    const io = new IntersectionObserver((entries) => {
      entries.forEach(ent => {
        if (ent.isIntersecting) {
          ent.target.classList.add('revealed');
          ent.target.classList.remove('hidden');
          io.unobserve(ent.target);
        }
      });
    }, { threshold: 0.12 });

    // Hover tilt (cards created later)

    // --- Data: curated places (images use Unsplash CDN as fallbacks; use /images/<id>.jpg if available) ---
    // I curated 30+ places across Nepal with coordinates, categories and unsplash references.
    const PLACES = [
      { id: 'everest', title: 'Everest Base Camp', category: 'mountains', lat: 28.0043, lon: 86.8576, rating: 4.6, desc: 'Trek to the world‚Äôs highest peak region. Expect alpine scenery and teahouse stays.', img: 'https://images.unsplash.com/photo-1508264165352-cb0b5829d6ea?w=1200&auto=format&fit=crop&q=80' },
      { id: 'phewa', title: 'Phewa Lake, Pokhara', category: 'lakes', lat: 28.2096, lon: 83.9856, rating: 4.4, desc: 'Boating, island temples and views of Annapurna.', img: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80' },
      { id: 'pashupati', title: 'Pashupatinath Temple', category: 'temples', lat: 27.7100, lon: 85.3488, rating: 4.2, desc: 'One of Hinduism‚Äôs most important temples.', img: 'https://images.unsplash.com/photo-1531925470850-34f1b4b27f16?w=1200&auto=format&fit=crop&q=80' },
      { id: 'bhaktapur', title: 'Bhaktapur Durbar Square', category: 'heritage', lat: 27.6726, lon: 85.4270, rating: 4.3, desc: 'Medieval city with Newari architecture.', img: 'https://images.unsplash.com/photo-1505765053275-76c2f4f7d3a0?w=1200&auto=format&fit=crop&q=80' },
      { id: 'chitwan', title: 'Chitwan National Park', category: 'wildlife', lat: 27.5389, lon: 84.3542, rating: 4.5, desc: 'Jungle safaris and wildlife spotting (rhinos).', img: 'https://images.unsplash.com/photo-1519846850226-817a9a4b6d1e?w=1200&auto=format&fit=crop&q=80' },
      { id: 'kathmandu', title: 'Kathmandu Durbar Square', category: 'heritage', lat: 27.7043, lon: 85.3131, rating: 4.1, desc: 'Historical palaces, temples and vibrant markets.', img: 'https://images.unsplash.com/photo-1526481280698-72c2f6b5c3b6?w=1200&auto=format&fit=crop&q=80' },
      { id: 'annapurna', title: 'Annapurna Circuit', category: 'trek', lat: 28.5969, lon: 83.8203, rating: 4.7, desc: 'Classic multi-day trek with diverse scenery.', img: 'https://images.unsplash.com/photo-1516569421960-8f9d2b07f9b6?w=1200&auto=format&fit=crop&q=80' },
      { id: 'gosaikunda', title: 'Gosaikunda Lake', category: 'lakes', lat: 28.2117, lon: 85.3250, rating: 4.3, desc: 'Sacred alpine lake, popular with pilgrims.', img: 'https://images.unsplash.com/photo-1482192505345-5655af888cc4?w=1200&auto=format&fit=crop&q=80' },
      { id: 'lumbini', title: 'Lumbini (Birthplace of Buddha)', category: 'heritage', lat: 27.6792, lon: 83.5070, rating: 4.4, desc: 'UNESCO World Heritage site and pilgrimage center.', img: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=1200&auto=format&fit=crop&q=80' },
      { id: 'tilicho', title: 'Tilicho Lake', category: 'lakes', lat: 28.5957, lon: 83.8106, rating: 4.1, desc: 'High-altitude lake with stunning reflections.', img: 'https://images.unsplash.com/photo-1526778548025-fa2f459cd5c0?w=1200&auto=format&fit=crop&q=80' },
      { id: 'langtang', title: 'Langtang Valley', category: 'trek', lat: 28.2050, lon: 85.5512, rating: 4.2, desc: 'Accessible trek north of Kathmandu.', img: 'https://images.unsplash.com/photo-1470770903676-69b98201ea1c?w=1200&auto=format&fit=crop&q=80' },
      { id: 'rara', title: 'Rara Lake', category: 'lakes', lat: 29.2306, lon: 82.3236, rating: 4.1, desc: 'Remote, pristine lake in the far west.', img: 'https://images.unsplash.com/photo-1482192596544-9eb88f363b5d?w=1200&auto=format&fit=crop&q=80' },
      { id: 'manang', title: 'Manang Valley', category: 'trek', lat: 28.6736, lon: 84.0133, rating: 4.5, desc: 'High-altitude culture and base for Annapurna treks.', img: 'https://images.unsplash.com/photo-1549880338-65ddcdfd017b?w=1200&auto=format&fit=crop&q=80' },
      { id: 'gokyo', title: 'Gokyo Lakes', category: 'lakes', lat: 27.9531, lon: 86.6969, rating: 4.6, desc: 'Stunning glacial lakes with views of Everest.', img: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?w=1200&auto=format&fit=crop&q=80' },
      { id: 'nagarkot', title: 'Nagarkot Sunrise Point', category: 'mountains', lat: 27.7090, lon: 85.4296, rating: 4.2, desc: 'Short drive from Kathmandu for sunrise mountain views.', img: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1200&auto=format&fit=crop&q=80' },
      { id: 'patan', title: 'Patan Durbar Square', category: 'heritage', lat: 27.6722, lon: 85.3206, rating: 4.1, desc: 'Historic city known for metalwork and ancient temples.', img: 'https://images.unsplash.com/photo-1516574187841-cb9cc2ca948b?w=1200&auto=format&fit=crop&q=80' },
      { id: 'bandipur', title: 'Bandipur Hilltop', category: 'cultural', lat: 27.9961, lon: 84.4522, rating: 4.3, desc: 'Quiet hilltop town with preserved architecture.', img: 'https://images.unsplash.com/photo-1494526585095-c41746248156?w=1200&auto=format&fit=crop&q=80' },
      { id: 'koshi', title: 'Koshi Tappu Wildlife Reserve', category: 'wildlife', lat: 26.5206, lon: 87.0455, rating: 4.0, desc: 'Important wetland and birdwatching destination.', img: 'https://images.unsplash.com/photo-1482192596544-9eb88f363b5d?w=1200&auto=format&fit=crop&q=80' },
      { id: 'uppermustang', title: 'Upper Mustang', category: 'cultural', lat: 28.9989, lon: 83.8233, rating: 4.4, desc: 'Ancient trans-Himalayan kingdom with desert landscapes.', img: 'https://images.unsplash.com/photo-1501769214405-5e86f7d1b3d1?w=1200&auto=format&fit=crop&q=80' },
      { id: 'dolpa', title: 'Dolpo Region', category: 'trek', lat: 29.0107, lon: 82.9200, rating: 4.4, desc: 'Remote trekking region with Tibetan-influenced culture.', img: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80' },
      // Additional sample entries ‚Äî duplicate variations to demonstrate large lists
      { id: 'annapurna_base', title: 'Annapurna Base Camp', category: 'trek', lat: 28.5951, lon: 83.8200, rating: 4.7, desc: 'Iconic trek into the heart of the Annapurnas.', img: 'https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1200&auto=format&fit=crop&q=80' },
      { id: 'seti_gorge', title: 'Seti River Gorge', category: 'nature', lat: 28.2230, lon: 83.9779, rating: 4.0, desc: 'River gorge near Pokhara with striking geology.', img: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80' },
      { id: 'boudhanath', title: 'Boudhanath Stupa', category: 'heritage', lat: 27.7215, lon: 85.3617, rating: 4.5, desc: 'One of the largest spherical stupas in the world.', img: 'https://images.unsplash.com/photo-1506126613408-eca07ce68773?w=1200&auto=format&fit=crop&q=80' },
      { id: 'sagarmatha', title: 'Sagarmatha National Park', category: 'nationalpark', lat: 27.9800, lon: 86.9236, rating: 4.6, desc: 'Protects the Everest region and its biodiversity.', img: 'https://images.unsplash.com/photo-1508264165352-cb0b5829d6ea?w=1200&auto=format&fit=crop&q=80' },
      { id: 'patan_museum', title: 'Patan Museum', category: 'museum', lat: 27.6724, lon: 85.3196, rating: 4.2, desc: 'Art and artifacts of the Kathmandu valley.', img: 'https://images.unsplash.com/photo-1494526585095-c41746248156?w=1200&auto=format&fit=crop&q=80' },
      { id: 'kathmandu_garden', title: 'Garden of Dreams', category: 'cultural', lat: 27.7080, lon: 85.3166, rating: 4.0, desc: 'Colonial-era historical garden for relaxation.', img: 'https://images.unsplash.com/photo-1526778548025-fa2f459cd5c0?w=1200&auto=format&fit=crop&q=80' },
      { id: 'sankhu', title: 'Sankhu Ancient Town', category: 'heritage', lat: 27.7097, lon: 85.4312, rating: 3.9, desc: 'Old town with traditional lanes and temples.', img: 'https://images.unsplash.com/photo-1494526585095-c41746248156?w=1200&auto=format&fit=crop&q=80' }
    ];

    // Create additional synthetic entries to demonstrate scale (the UI remains performant via clustering and virtual rendering)
    for (let i = 1; i <= 60; i++) {
      PLACES.push({
        id: 'place_' + i,
        title: `Sample Place ${i}`,
        category: ['mountains','lakes','temples','heritage','wildlife','trek','cultural'][i % 7],
        lat: 27.5 + (i * 0.02),
        lon: 85.1 + (i * 0.03),
        rating: (3.5 + (i % 15) * 0.1).toFixed(1),
        desc: `Sample description for place ${i}. Use /images/place_${i}.jpg to supply a local image.`,
        img: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80'
      });
    }

    // --- Local storage keys versioning ---
    const favKey = 'explore_favs_v5';
    const itinKey = 'explore_itin_v5';
    const reviewsPrefix = 'explore_reviews_v5_';
    const chatKey = 'explore_chat_v2';

    // --- Rendering places (virtualizable) ---
    const destinationsRoot = $('#destinations');

    function createPlaceCard(p) {
      const imgSrc = `/images/${p.id}.jpg`;
      const img = el('img', { src: imgSrc, alt: p.title, loading: 'lazy' });
      // fallback on error to unsplash
      img.addEventListener('error', () => { if (!img.dataset.fallback) { img.src = p.img; img.dataset.fallback = '1'; } });

      const article = el('article',
        { class: 'card hidden', 'data-id': p.id, 'data-category': p.category, 'data-lat': p.lat, 'data-lon': p.lon, role: 'listitem', draggable: true, 'aria-labelledby': p.id + '-title' },
        el('div', { class: 'media' }, img),
        el('div', { class: 'info' },
          el('h3', { id: p.id + '-title' }, p.title),
          el('p', {}, p.desc),
          el('div', { class: 'meta' },
            el('div', { class: 'actions' },
              el('button', { class: 'btn small details-btn', 'data-id': p.id, type: 'button' }, 'Details'),
              el('button', { class: 'btn small quick-fav', 'data-id': p.id, type: 'button', title: 'Favorite' }, '‚òÜ'),
              el('button', { class: 'btn small', 'aria-label': 'Quick actions', 'data-id': p.id, type: 'button', onClick: (ev) => openQuickMenu(ev, p.id) }, '‚ãØ')
            ),
            el('div', { class: 'rating', title: `${p.rating} out of 5` },
              el('span', {}, '‚òÖ'),
              el('strong', { class: 'rating-value', 'data-id': p.id }, String(p.rating))
            )
          )
        )
      );

      // drag support
      article.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', p.id));
      article.addEventListener('dblclick', () => addToItin(p.id));

      // reveal observer
      io.observe(article);
      return article;
    }

    // populate
    function renderPlaces(list = PLACES) {
      destinationsRoot.innerHTML = '';
      list.forEach(p => destinationsRoot.appendChild(createPlaceCard(p)));
      attachCardInteractions();
    }
    renderPlaces();

    // --- Search with autocomplete ---
    const searchInput = $('#global-search');
    const suggestionBox = $('#search-suggestions');

    function fuzzyContains(text, q) {
      if (!q) return true;
      text = (text || '').toLowerCase(); q = q.toLowerCase();
      if (text.includes(q)) return true;
      let i = 0, j = 0;
      while (i < text.length && j < q.length) {
        if (text[i] === q[j]) j++;
        i++;
      }
      return j === q.length;
    }

    function showSuggestions(items) {
      suggestionBox.innerHTML = '';
      if (!items || items.length === 0) { suggestionBox.style.display = 'none'; suggestionBox.setAttribute('aria-hidden','true'); return; }
      items.slice(0,8).forEach(it => {
        const node = el('div', { role: 'option', tabindex: 0, class: 'suggestion-item' }, `${it.title} ‚Äî ${it.category}`);
        node.addEventListener('click', () => { searchInput.value = it.title; filterAndSearch(); suggestionBox.style.display = 'none'; });
        node.addEventListener('keydown', e => { if (e.key === 'Enter') node.click(); });
        suggestionBox.appendChild(node);
      });
      suggestionBox.style.display = 'block'; suggestionBox.setAttribute('aria-hidden','false');
    }

    function filterAndSearch() {
      const q = (searchInput.value || '').trim().toLowerCase();
      const active = document.querySelector('.filter-btns button.active')?.dataset.filter || 'all';
      $$('#destinations .card').forEach(card => {
        const matchesFilter = active === 'all' || card.dataset.category === active;
        const text = (card.querySelector('h3')?.textContent || '') + ' ' + (card.querySelector('p')?.textContent || '') + ' ' + (card.dataset.id || '');
        const matchesSearch = q === '' || fuzzyContains(text, q);
        card.style.display = matchesFilter && matchesSearch ? 'block' : 'none';
      });
      // suggestions
      if (q.length >= 2) {
        const results = PLACES.filter(p => fuzzyContains(p.title + ' ' + p.desc + ' ' + p.category, q));
        showSuggestions(results);
      } else {
        suggestionBox.style.display = 'none';
      }
    }
    searchInput.addEventListener('input', filterAndSearch);
    searchInput.addEventListener('focus', () => { if (searchInput.value.length >= 2) filterAndSearch(); });
    document.addEventListener('click', e => { if (!$('.search').contains(e.target)) suggestionBox.style.display = 'none'; });

    // Filter buttons
    $$('.filter-btns button').forEach(btn => btn.addEventListener('click', () => {
      $$('.filter-btns button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterAndSearch();
      analytics.track('filter_change', { filter: btn.dataset.filter });
    }));

    // Sorting
    $('#sort-by').addEventListener('change', e => {
      const val = e.target.value;
      const parent = $('#destinations');
      const nodes = $$('#destinations .card').slice();
      nodes.sort((a, b) => {
        const ra = parseFloat(a.querySelector('.rating-value')?.textContent || 0);
        const rb = parseFloat(b.querySelector('.rating-value')?.textContent || 0);
        const ta = a.querySelector('h3')?.textContent || '';
        const tb = b.querySelector('h3')?.textContent || '';
        if (val === 'rating-desc') return rb - ra;
        if (val === 'rating-asc') return ra - rb;
        if (val === 'alpha') return ta.localeCompare(tb);
        return 0;
      });
      nodes.forEach(n => parent.appendChild(n));
      analytics.track('sort_change', { sort: val });
    });

    // Favorites
    function loadFavs() { return JSON.parse(localStorage.getItem(favKey) || '[]'); }
    function saveFavs(list) { localStorage.setItem(favKey, JSON.stringify(list)); updateFavUI(); }
    function toggleFav(id) {
      const list = loadFavs(); const idx = list.indexOf(id);
      if (idx >= 0) list.splice(idx, 1); else list.push(id);
      saveFavs(list);
      analytics.track('fav_toggle', { id, state: list.includes(id) });
    }
    function updateFavUI() {
      const list = loadFavs();
      $('#fav-count').textContent = list.length;
      $$('#destinations .card').forEach(card => {
        const id = card.dataset.id;
        const quickBtn = card.querySelector('[data-id="' + id + '"].quick-fav');
        if (quickBtn) quickBtn.textContent = list.includes(id) ? '‚òÖ' : '‚òÜ';
      });
    }
    document.addEventListener('click', e => {
      if (e.target.matches('.quick-fav')) { toggleFav(e.target.dataset.id); }
      if (e.target.matches('#view-favs')) {
        const list = loadFavs();
        if (list.length === 0) return alert('No favorites yet.');
        const html = '<h3>Favorites</h3><ul>' + list.map(id => {
          const c = document.querySelector('.card[data-id="' + id + '"]');
          return '<li>' + (c ? c.querySelector('h3').textContent : id) + '</li>';
        }).join('') + '</ul>';
        openModal(html);
      }
    });
    updateFavUI();

    // --- Itinerary (drag & drop + local) ---
    function loadItin() { return JSON.parse(localStorage.getItem(itinKey) || '[]'); }
    function saveItin(list) { localStorage.setItem(itinKey, JSON.stringify(list)); renderItin(); updateMiniItin(); updateMapItinerary(); }
    function addToItin(id) {
      const list = loadItin();
      if (!list.includes(id)) { list.push(id); saveItin(list); analytics.track('itin_add', { id }); }
    }
    function renderItin() {
      const box = $('#itinerary-box'); const list = loadItin();
      if (!list || list.length === 0) { box.innerHTML = 'No items ‚Äî add places to build an itinerary.'; return; }
      box.innerHTML = '<ol id="itin-list" style="padding-left:18px">' + list.map(id => {
        const c = document.querySelector('.card[data-id="' + id + '"]'); const title = c ? c.querySelector('h3').textContent : id;
        return `<li data-id="${id}" draggable="true" style="padding:8px;border-bottom:1px dashed rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center">
                <span>${title}</span>
                <span style="display:inline-flex;gap:6px"><button class="btn ghost small move-up" type="button">‚Üë</button><button class="btn ghost small move-down" type="button">‚Üì</button><button class="btn ghost small remove-itin" type="button">‚úï</button></span>
                </li>`;
      }).join('') + '</ol>';
      attachItinHandlers();
    }
    function attachItinHandlers() {
      const listEl = $('#itin-list');
      if (!listEl) return;
      let dragSrc = null;
      listEl.querySelectorAll('li').forEach(li => {
        li.addEventListener('dragstart', e => { dragSrc = li; e.dataTransfer.effectAllowed = 'move'; li.style.opacity = 0.4; });
        li.addEventListener('dragend', () => li.style.opacity = '');
        li.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        li.addEventListener('drop', e => {
          e.preventDefault();
          if (!dragSrc || dragSrc === li) return;
          const items = loadItin(); const srcId = dragSrc.dataset.id; const dstId = li.dataset.id;
          const srcIdx = items.indexOf(srcId); const dstIdx = items.indexOf(dstId);
          if (srcIdx < 0 || dstIdx < 0) return;
          items.splice(srcIdx, 1); items.splice(dstIdx, 0, srcId); saveItin(items);
        });
      });
      listEl.querySelectorAll('.move-up').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx > 0) { items.splice(idx, 1); items.splice(idx - 1, 0, id); saveItin(items); }
      }));
      listEl.querySelectorAll('.move-down').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx >= 0 && idx < items.length - 1) { items.splice(idx, 1); items.splice(idx + 1, 0, id); saveItin(items); }
      }));
      listEl.querySelectorAll('.remove-itin').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx >= 0) { items.splice(idx, 1); saveItin(items); }
      }));
    }
    // Drag from grid to itinerary
    $$('#destinations .card').forEach(card => {
      card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', card.dataset.id));
      card.addEventListener('dblclick', () => addToItin(card.dataset.id));
    });
    $('#itinerary-box').addEventListener('dragover', e => e.preventDefault());
    $('#itinerary-box').addEventListener('drop', e => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); if (id) addToItin(id); });

    renderItin();

    function updateMiniItin() {
      const mini = $('#mini-itin-list'); const list = loadItin();
      if (!list || list.length === 0) { mini.textContent = 'No items yet'; return; }
      mini.innerHTML = list.map(id => `<div>${document.querySelector('.card[data-id="${id}"] h3')?.textContent || id}</div>`).join('');
    }
    updateMiniItin();

    // Export / Import
    $('#export-json').addEventListener('click', () => {
      const data = { places: PLACES, itinerary: loadItin(), exported: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'explore-nepal-export.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#import-itin').addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.addEventListener('change', async () => {
        const f = input.files[0]; if (!f) return;
        const txt = await f.text();
        try {
          const parsed = JSON.parse(txt);
          if (parsed.itinerary) { saveItin(parsed.itinerary); alert('Itinerary imported'); }
          else alert('JSON does not contain itinerary');
        } catch (e) { alert('Invalid JSON'); }
      });
      input.click();
    });
    $('#export-ics').addEventListener('click', () => {
      const items = loadItin();
      let ics = 'BEGIN:VCALENDAR\\nVERSION:2.0\\nPRODID:-//ExploreNepal//EN\\n';
      items.forEach((id, idx) => {
        const title = document.querySelector('.card[data-id="' + id + '"] h3')?.textContent || id;
        const dt = new Date(); dt.setDate(dt.getDate() + idx);
        const dtstr = dt.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        ics += `BEGIN:VEVENT\\nUID:${id}@explorenepal\\nDTSTAMP:${dtstr}\\nDTSTART:${dtstr}\\nSUMMARY:${title}\\nEND:VEVENT\\n`;
      });
      ics += 'END:VCALENDAR';
      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'itinerary.ics'; a.click(); URL.revokeObjectURL(url);
    });

    // Clear itinerary
    $('#clear-itin').addEventListener('click', () => { if (confirm('Clear itinerary?')) { saveItin([]); } });

    // --- Modal & lightbox ---
    const modalRoot = $('#modal-root');
    function openModal(innerHtml) {
      modalRoot.style.display = 'block'; modalRoot.setAttribute('aria-hidden', 'false');
      modalRoot.innerHTML = '';
      const dialog = el('div', { role: 'dialog', 'aria-modal': 'true', style: 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;z-index:18000' });
      const content = el('div', { style: 'background:var(--card);border-radius:12px;padding:16px;max-width:760px;width:100%;max-height:85vh;overflow:auto;box-shadow:var(--shadow-strong)' });
      content.innerHTML = innerHtml;
      const close = el('div', { style: 'text-align:right;margin-top:12px' }, el('button', { class: 'btn ghost', type: 'button', onClick: closeModal }, 'Close'));
      content.appendChild(close);
      dialog.appendChild(content); modalRoot.appendChild(dialog);
    }
    function closeModal() { modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; modalRoot.setAttribute('aria-hidden', 'true'); }
    window.openImage = (src) => {
      const lb = $('#lightbox'); const img = $('#lightbox-img');
      img.src = src; lb.classList.add('open'); lb.setAttribute('aria-hidden', 'false');
    };
    window.closeLightbox = () => { const lb = $('#lightbox'); lb.classList.remove('open'); lb.setAttribute('aria-hidden', 'true'); $('#lightbox-img').src = ''; };

    // Quick menu for cards
    const quickMenu = $('#quick-menu');
    window.openQuickMenu = (ev, id) => {
      ev.preventDefault();
      const rect = (ev.currentTarget || ev.target).getBoundingClientRect();
      quickMenu.style.top = (rect.bottom + window.scrollY + 8) + 'px';
      quickMenu.style.left = (rect.left + window.scrollX) + 'px';
      quickMenu.innerHTML = '';
      const title = (document.querySelector('.card[data-id="' + id + '"] h3')?.textContent) || id;
      quickMenu.appendChild(el('div', {}, el('div', { style: 'font-weight:800;margin-bottom:6px' }, title)));
      quickMenu.appendChild(el('button', { class: 'btn small', type: 'button', onClick: () => { addToItin(id); quickMenu.style.display = 'none'; } }, 'Add to itinerary'));
      quickMenu.appendChild(el('button', { class: 'btn small ghost', type: 'button', onClick: () => { toggleFav(id); quickMenu.style.display = 'none'; } }, 'Toggle favorite'));
      quickMenu.appendChild(el('button', { class: 'btn small ghost', type: 'button', onClick: () => { document.querySelector('.details-btn[data-id="' + id + '"]').click(); quickMenu.style.display = 'none'; } }, 'Details'));
      quickMenu.style.display = 'block';
      setTimeout(() => { document.addEventListener('click', closeQuickOnOutside, { once: true }); }, 10);
    };
    function closeQuickOnOutside(e) { if (!quickMenu.contains(e.target)) quickMenu.style.display = 'none'; }
    document.addEventListener('scroll', () => quickMenu.style.display = 'none');

    // Reviews storage
    function loadReviews(id) { return JSON.parse(localStorage.getItem(reviewsPrefix + id) || '[]'); }
    function addReview(id, rev) { const arr = loadReviews(id); arr.unshift(rev); localStorage.setItem(reviewsPrefix + id, JSON.stringify(arr)); }

    // Details & booking handling
    document.addEventListener('click', async (e) => {
      // Details
      if (e.target.matches('.details-btn')) {
        const id = e.target.dataset.id; const card = document.querySelector('.card[data-id="' + id + '"]');
        if (!card) return;
        const title = card.querySelector('h3').textContent; const desc = card.querySelector('p').textContent;
        const lat = card.dataset.lat, lon = card.dataset.lon;
        const reviews = loadReviews(id);
        const avg = reviews.length ? (reviews.reduce((s,r)=>s+r.rating,0)/reviews.length).toFixed(1) : '‚Äî';
        const reviewsHtml = reviews.length ? reviews.map(r => `<div style="border-top:1px dashed #eee;padding-top:8px"><div style="color:gold">${'‚òÖ'.repeat(r.rating)}</div><div>${r.text}</div><div class="muted" style="font-size:.8rem">${new Date(r.created).toLocaleString()}</div></div>`).join('') : '<div class="muted">No reviews yet</div>';
        const galleryHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <img style="width:120px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer" src="/images/${id}.jpg" alt="${title}" onerror="this.style.opacity=.6" onclick="openImage(this.src)">
          <img style="width:120px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer" src="${PLACES.find(p=>p.id===id)?.img || '/images/' + id + '-2.jpg'}" alt="${title} photo 2" onerror="this.style.opacity=.6" onclick="openImage(this.src)">
        </div>`;
        const html = `<h3>${title} <small style="font-weight:700;color:var(--muted)">(${avg})</small></h3><p class="muted">${desc}</p>${galleryHtml}<div id="detail-weather">Loading weather...</div><h4 style="margin-top:12px">Reviews</h4>${reviewsHtml}
          <h4 style="margin-top:12px">Add a review</h4>
          <div style="display:flex;gap:8px;align-items:center"><label>Rating</label>
          <select id="review-rating"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
          <div style="margin-top:8px"><textarea id="review-text" style="width:100%;height:100px" placeholder="Tell others what you liked..."></textarea></div>
          <div style="margin-top:8px;text-align:right"><button id="submit-review" class="btn">Submit review</button> <button id="book-from-modal" class="btn ghost" data-id="${id}">Book this</button></div>`;
        openModal(html);
        if (lat && lon) fetchWeatherFor(lat, lon, document.getElementById('detail-weather'));
        document.getElementById('submit-review').addEventListener('click', () => {
          const text = (document.getElementById('review-text').value || '').trim(); const rating = parseInt(document.getElementById('review-rating').value, 10);
          if (!text) return alert('Please add a review message.');
          addReview(id, { rating, text, created: new Date().toISOString() });
          alert('Thanks ‚Äî your review was saved locally.');
          closeModal();
        });
        document.getElementById('book-from-modal').addEventListener('click', () => openBookingForm(id));
      }

      // Book buttons that may be rendered dynamically
      if (e.target.matches('#book-from-modal') || e.target.matches('.book-btn')) {
        const id = e.target.dataset.id || e.target.closest('[data-id]')?.dataset?.id;
        if (id) openBookingForm(id);
      }
    });

    function openBookingForm(id) {
      const c = document.querySelector('.card[data-id="' + id + '"]'); const title = c ? c.querySelector('h3').textContent : id;
      const html = `<h3>Book: ${title}</h3>
        <form id="booking-form">
          <label style="display:block;margin-top:6px">Name</label><input id="bk-name" required style="width:100%;padding:8px;margin:6px 0">
          <label style="display:block">Email</label><input id="bk-email" type="email" required style="width:100%;padding:8px;margin:6px 0">
          <label style="display:block">Dates</label><input id="bk-dates" type="text" placeholder="e.g. 2026-03-12 to 2026-03-26" required style="width:100%;padding:8px;margin:6px 0">
          <div style="margin-top:8px;text-align:right"><button class="btn" type="submit">Send request</button></div>
        </form>`;
      openModal(html);
      document.getElementById('booking-form').addEventListener('submit', e => {
        e.preventDefault();
        const name = (document.getElementById('bk-name').value || '').trim(); const email = (document.getElementById('bk-email').value || '').trim(); const dates = (document.getElementById('bk-dates').value || '').trim();
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        bookings.push({ id, name, email, dates, created: new Date().toISOString() });
        localStorage.setItem('bookings', JSON.stringify(bookings));
        alert('Booking request saved locally. We will contact you at ' + email);
        closeModal();
        analytics.track('booking_request', { id, name, email });
      });
    }

    // --- Weather: Open-Meteo (simple) ---
    async function fetchWeatherFor(lat, lon, target) {
      if (!lat || !lon) { if (target) target.textContent = 'No coordinates available.'; return; }
      try {
        if (target) target.textContent = 'Loading weather...';
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        const data = await res.json();
        if (data && data.current_weather) {
          const w = data.current_weather;
          if (target) target.innerHTML = `<strong>Current:</strong> ${w.temperature}¬∞C, wind ${w.windspeed} km/h`;
          const heroTemp = $('#hero-temp'); if (heroTemp) heroTemp.textContent = `${w.temperature}¬∞C`;
        } else if (target) target.textContent = 'Weather data unavailable.';
      } catch (err) {
        if (target) target.textContent = 'Failed to load weather.';
      }
    }
    fetchWeatherFor(27.7172, 85.3240, $('#weather-widget'));

    // --- Currency converter ---
    $('#convert-btn').addEventListener('click', async () => {
      const amount = Number($('#cur-amount').value) || 1; const from = $('#cur-from').value; const to = $('#cur-to').value;
      const out = $('#convert-result'); out.textContent = 'Converting‚Ä¶';
      try {
        const r = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`);
        const data = await r.json();
        if (data && data.result !== undefined) out.textContent = `${amount} ${from} ‚âà ${data.result.toFixed(2)} ${to}`;
        else out.textContent = 'Conversion failed.';
      } catch (e) { out.textContent = 'Conversion failed.'; }
    });

    // --- Newsletter ---
    $('#newsletter').addEventListener('submit', e => {
      e.preventDefault(); const email = ($('#newsletter-email').value || '').trim();
      const subs = JSON.parse(localStorage.getItem('subs') || '[]'); subs.push({ email, created: new Date().toISOString() }); localStorage.setItem('subs', JSON.stringify(subs));
      $('#newsletter-msg').textContent = 'Thanks! Subscribed: ' + email;
      analytics.track('subscribe', { email });
    });

    // --- Chat assistant (enhanced intents) ---
    const chatMessages = $('#chat-messages'); const userInput = $('#user-input'); const sendBtn = $('#send-btn'); const chatStatus = $('#chat-status');
    let chatCollapsed = false;
    let voiceEnabled = false;
    let recognition = null;

    function loadChat() { return JSON.parse(localStorage.getItem(chatKey) || '[]'); }
    function saveChat(log) { localStorage.setItem(chatKey, JSON.stringify(log)); }
    function appendMsg(who, text, meta = {}) {
      const wrapper = el('div', { class: 'msg ' + (who === 'You' ? 'user' : 'bot') });
      const avatar = el('div', { class: 'avatar-mini' }, who === 'You' ? 'You' : 'GN');
      const bubble = el('div', { class: 'bubble' });
      bubble.textContent = text;
      const time = el('div', { class: 'time muted' }, (new Date()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
      bubble.appendChild(time);
      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      const log = loadChat(); log.push({ who, text, meta, time: new Date().toISOString() }); saveChat(log);
    }
    function hydrateChat() {
      const log = loadChat();
      if (!log || !log.length) {
        appendMsg('Guide', 'Hi ‚Äî I am your local guide. Try "Weather in Pokhara", "Suggest itinerary" or "Book Everest trek".');
        return;
      }
      chatMessages.innerHTML = '';
      log.forEach(item => {
        const wrapper = el('div', { class: 'msg ' + (item.who === 'You' ? 'user' : 'bot') });
        const avatar = el('div', { class: 'avatar-mini' }, item.who === 'You' ? 'You' : 'GN');
        const bubble = el('div', { class: 'bubble' }); bubble.textContent = item.text;
        const time = el('div', { class: 'time muted' }, new Date(item.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
        bubble.appendChild(time);
        wrapper.appendChild(avatar); wrapper.appendChild(bubble);
        chatMessages.appendChild(wrapper);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    hydrateChat();

    function appendTyping() {
      const node = el('div', { class: 'msg bot typing-wrap' });
      const av = el('div', { class: 'avatar-mini' }, 'GN');
      const b = el('div', { class: 'bubble' });
      const t = el('span', { class: 'typing' });
      b.appendChild(t); node.appendChild(av); node.appendChild(b);
      chatMessages.appendChild(node); chatMessages.scrollTop = chatMessages.scrollHeight;
      return node;
    }
    function removeNode(n) { if (n && n.parentNode) n.parentNode.removeChild(n); }

    async function handleUserMessage(text) {
      appendMsg('You', text);
      chatStatus.textContent = 'Typing...';
      const typingNode = appendTyping();
      await new Promise(r => setTimeout(r, 400 + Math.random() * 800));

      const low = text.toLowerCase();
      let reply = "I can help with weather, bookings, itineraries, local tips and transport. Try: 'Weather in Pokhara', 'Book Everest', 'Suggest itinerary'.";
      let actions = [];

      if (/weather|forecast|‡§Æ‡•å‡§∏‡§Æ|‡§∏‡•ç‡§•‡§ø‡§§‡§ø/.test(low)) {
        const place = PLACES.find(p => low.includes(p.id) || low.includes(p.title.toLowerCase()));
        if (place) {
          try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${place.lat}&longitude=${place.lon}&current_weather=true`);
            const data = await res.json();
            if (data && data.current_weather) {
              const w = data.current_weather;
              reply = `${place.title}: ${w.temperature}¬∞C, wind ${w.windspeed} km/h.`;
            } else reply = `Couldn't fetch weather for ${place.title}.`;
          } catch (e) { reply = 'Weather service unavailable.'; }
        } else reply = "Which place? e.g. 'Weather in Pokhara' or 'Weather at Everest'.";
      } else if (/book|booking|reserve|reserve a spot/.test(low)) {
        const place = PLACES.find(p => low.includes(p.id) || low.includes(p.title.toLowerCase()));
        if (place) {
          reply = `To book ${place.title} I can open the booking form. Would you like me to open it?`;
          actions = [{ label: 'Open booking', action: () => openBookingForm(place.id) }, { label: 'Add to itinerary', action: () => { addToItin(place.id); alert('Added to itinerary'); } }];
        } else reply = 'Which place would you like to book?';
      } else if (/suggest|recommend|itinerary/.test(low)) {
        reply = 'Suggested 7-day itinerary: Day 1 Kathmandu (heritage), Day 2 Drive to Pokhara, Day 3 Phewa Lake & sunrise, Day 4 Pokhara to Chitwan (safari), Day 5 Jungle activities, Day 6 Return to Pokhara, Day 7 Fly to Kathmandu. Save sample items?';
        actions = [{ label: 'Save sample items', action: () => { addToItin('phewa'); addToItin('chitwan'); alert('Sample items added to itinerary'); } }];
      } else if (/nearby|close|near me/.test(low)) {
        reply = 'Use Locate me to find places near your position.';
      } else {
        const matched = PLACES.find(p => low.includes(p.id) || low.includes(p.title.toLowerCase()));
        if (matched) reply = `${matched.title}: ${matched.desc}`;
        else reply = 'Sorry I did not fully understand. Try asking about weather, bookings, or say "suggest itinerary".';
      }

      removeNode(typingNode);
      appendMsg('Guide', reply);

      if (actions.length) {
        const last = chatMessages.lastElementChild;
        const chipRow = el('div', { class: 'chat-suggests' });
        actions.forEach(a => {
          const c = el('div', { class: 'chip', role: 'button', tabIndex: 0 }, a.label);
          c.addEventListener('click', () => a.action());
          chipRow.appendChild(c);
        });
        last.querySelector('.bubble').appendChild(chipRow);
      }

      chatStatus.textContent = 'Online';
      analytics.track('chat_interaction', { text, replySummary: reply.slice(0, 120) });
      if (voiceEnabled && 'speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(reply);
        u.lang = 'en-US';
        speechSynthesis.cancel(); speechSynthesis.speak(u);
      }
    }

    sendBtn.addEventListener('click', () => { const v = userInput.value.trim(); if (!v) return; handleUserMessage(v); userInput.value = ''; });
    userInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); } });

    $$('#chat-suggests .chip').forEach(c => c.addEventListener('click', e => {
      const t = e.currentTarget.dataset.s;
      if (t === '#suggest_weather') { handleUserMessage('Weather in Pokhara'); }
      if (t === '#suggest_itin') { handleUserMessage('Suggest itinerary'); }
      if (t === '#suggest_book') { handleUserMessage('Book Everest'); }
    }));

    // Voice toggle (synthesis + optional recognition)
    $('#voice-toggle').addEventListener('click', async () => {
      voiceEnabled = !voiceEnabled;
      $('#voice-toggle').textContent = voiceEnabled ? 'üîä' : 'ÔøΩÔøΩÔøΩ';
      analytics.track('voice_toggle', { enabled: voiceEnabled });
      try {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (voiceEnabled && SR) {
          recognition = new SR();
          recognition.lang = 'en-US';
          recognition.interimResults = false;
          recognition.maxAlternatives = 1;
          recognition.onresult = (ev) => {
            const t = ev.results[0][0].transcript;
            userInput.value = t; sendBtn.click();
          };
          recognition.onerror = () => { recognition = null; };
          recognition.start();
        } else {
          if (recognition) recognition.stop();
        }
      } catch (err) { console.warn('Voice not supported'); }
    });

    // Chat minimize toggle
    $('#chat-minimize').addEventListener('click', () => {
      const panel = $('#chat-panel'); panel.classList.toggle('minimized');
    });

    // --- Map: Leaflet + marker clustering + layers ---
    const map = L.map('leaflet-map', { minZoom: 6 }).setView([28.3949, 84.1240], 7);
    const basemap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const markerCluster = L.markerClusterGroup({ chunkedLoading: true });
    const layerGroups = { mountains: L.layerGroup(), lakes: L.layerGroup(), temples: L.layerGroup(), heritage: L.layerGroup(), wildlife: L.layerGroup(), trek: L.layerGroup(), cultural: L.layerGroup(), nature: L.layerGroup(), nationalpark: L.layerGroup(), museum: L.layerGroup() };

    // Add markers
    function buildMarkers() {
      markerCluster.clearLayers();
      PLACES.forEach(p => {
        const marker = L.marker([p.lat, p.lon], { title: p.title });
        marker.bindPopup(`<strong>${p.title}</strong><br>${p.desc}<br><button class="btn small" onclick="openModalFromMap('${p.id}')">Details</button> <button class="btn small ghost" onclick="addToItin('${p.id}')">Add to itinerary</button>`);
        marker.on('click', () => analytics.track('map_marker_click', { id: p.id }));
        markerCluster.addLayer(marker);
        const g = layerGroups[p.category] || layerGroups['nature'] || L.layerGroup();
        g.addLayer(marker);
      });
      map.addLayer(markerCluster);
      // add groups to control
      const overlays = {};
      Object.keys(layerGroups).forEach(k => overlays[k.charAt(0).toUpperCase() + k.slice(1)] = layerGroups[k]);
      L.control.layers(null, overlays, { collapsed: true }).addTo(map);
    }
    buildMarkers();

    // Open modal from map (safe wrapper)
    window.openModalFromMap = (id) => {
      const btn = document.querySelector('.details-btn[data-id="' + id + '"]');
      if (btn) btn.click();
    };

    // Filter checkboxes for layers
    $('#layer-mountains').addEventListener('change', (e) => {
      if (e.target.checked) map.addLayer(layerGroups.mountains); else map.removeLayer(layerGroups.mountains);
    });
    $('#layer-lakes').addEventListener('change', (e) => {
      if (e.target.checked) map.addLayer(layerGroups.lakes); else map.removeLayer(layerGroups.lakes);
    });

    // Locate me
    $('#locate-me').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        map.setView([lat, lon], 12);
        L.circle([lat, lon], { radius: Math.max(200, pos.coords.accuracy), color: '#0b67d0', fillOpacity: 0.1 }).addTo(map);
        analytics.track('locate_me', { lat, lon });
      }, (err) => alert('Unable to retrieve location: ' + err.message));
    });

    // Fit itinerary on map
    function updateMapItinerary() {
      const items = loadItin();
      if (!items || items.length === 0) { $('#map-info').textContent = 'No itinerary to fit'; return; }
      const latlngs = items.map(id => {
        const p = PLACES.find(x => x.id === id);
        return p ? [p.lat, p.lon] : null;
      }).filter(Boolean);
      if (latlngs.length === 0) { $('#map-info').textContent = 'No valid coordinates in itinerary'; return; }
      const bounds = L.latLngBounds(latlngs);
      map.fitBounds(bounds.pad(0.4));
      $('#map-info').textContent = `Fitted ${latlngs.length} points in itinerary`;
      // optional: draw a polyline for visualization
      if (window.currentItinPolyline) map.removeLayer(window.currentItinPolyline);
      window.currentItinPolyline = L.polyline(latlngs, { color: '#ff8c42' }).addTo(map);
    }
    $('#fit-itin').addEventListener('click', updateMapItinerary);

    // Map stats
    $('#map-info').textContent = `${PLACES.length} places loaded ‚Ä¢ clustering enabled`;

    // --- Attach card interactions (after DOM creation) ---
    function attachCardInteractions() {
      // hover tilt on all .card
      $$('.card').forEach(card => {
        card.addEventListener('pointermove', e => {
          const r = card.getBoundingClientRect();
          const px = (e.clientX - r.left) / r.width - 0.5;
          const py = (e.clientY - r.top) / r.height - 0.5;
          card.style.transform = `perspective(900px) rotateX(${ -py * 6 }deg) rotateY(${ px * 10 }deg) translateY(-6px) scale(1.01)`;
        });
        card.addEventListener('pointerleave', () => card.style.transform = '');
      });
    }

    // Details buttons (dynamic)
    document.addEventListener('click', (e) => {
      if (e.target.matches('.details-btn')) {
        const id = e.target.dataset.id; const btn = e.target;
        btn.disabled = true;
        setTimeout(() => btn.disabled = false, 500);
      }
    });

    // --- Offline / Service Worker registration (skeleton) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.log('Service worker registered', reg);
      }).catch(err => {
        console.warn('SW registration failed', err);
      });
    }

    // --- Hydration & state restore ---
    // Restore favorites showing
    updateFavUI();
    // Update any map-specific UI
    updateMapItinerary();

    // --- Small helpers & UI wiring ---
    $('#start-explore').addEventListener('click', () => { location.hash = '#places'; document.querySelector('#places h2').scrollIntoView({ behavior: 'smooth' }); analytics.track('start_explore'); });
    $('#open-map').addEventListener('click', () => { location.hash = '#map'; setTimeout(()=>map.invalidateSize(),300); analytics.track('open_map'); });

    // Print itinerary
    $('#print-itin').addEventListener('click', () => { window.print(); analytics.track('print_itin'); });

    // Share itinerary (simple copy)
    $('#share-itin').addEventListener('click', () => {
      const url = location.href.split('#')[0] + '#itinerary';
      navigator.clipboard?.writeText(url).then(()=> alert('Link copied to clipboard'), ()=> alert('Copy failed'));
    });

    // Nearby safari ‚Äî finds nearest wildlife places to user (requires location)
    $('#nearby-safari').addEventListener('click', () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const wildlife = PLACES.filter(p => p.category === 'wildlife' || p.category === 'nationalpark');
        wildlife.sort((a,b) => (distance(lat,lon,a.lat,a.lon) - distance(lat,lon,b.lat,b.lon)));
        if (wildlife.length) {
          openModal(`<h3>Nearby wildlife spots</h3><ul>${wildlife.slice(0,5).map(w=>`<li>${w.title} ‚Äî ${(distance(lat,lon,w.lat,w.lon)/1000).toFixed(1)} km</li>`).join('')}</ul>`);
        } else openModal('<div class="muted">No wildlife spots found in dataset.</div>');
      }, err => alert('Location failed: ' + err.message));
    });

    // Haversine distance (meters)
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Offline banner
    function updateOnlineStatus() {
      if (!navigator.onLine) { $('#offline-banner').style.display = 'block'; }
      else { $('#offline-banner').style.display = 'none'; }
    }
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();

    // Modal close on ESC
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    // Simple admin mode (local-only) ‚Äî open with ?admin=true
    if (location.search.includes('admin=true')) {
      const adminBtn = el('button', { class: 'btn', style: 'position:fixed;left:12px;top:80px;z-index:20000', onClick: openAdmin }, 'Admin');
      document.body.appendChild(adminBtn);
    }
    function openAdmin() {
      const html = `<h3>Admin (local-only)</h3>
        <p class="muted">Add a new place (saved in localStorage and appended to the current dataset; not pushed to repo)</p>
        <form id="admin-add">
          <label>Id<input id="admin-id" required style="width:100%;margin-top:6px"></label>
          <label>Title<input id="admin-title" required style="width:100%;margin-top:6px"></label>
          <label>Category<input id="admin-cat" required style="width:100%;margin-top:6px" value="heritage"></label>
          <label>Latitude<input id="admin-lat" required style="width:100%;margin-top:6px"></label>
          <label>Longitude<input id="admin-lon" required style="width:100%;margin-top:6px"></label>
          <label>Image URL<input id="admin-img" style="width:100%;margin-top:6px"></label>
          <div style="margin-top:8px;text-align:right"><button class="btn" type="submit">Add place</button></div>
        </form>`;
      openModal(html);
      document.getElementById('admin-add').addEventListener('submit', (ev) => {
        ev.preventDefault();
        const id = $('#admin-id').value.trim(); const title = $('#admin-title').value.trim();
        const category = $('#admin-cat').value.trim(); const lat = parseFloat($('#admin-lat').value); const lon = parseFloat($('#admin-lon').value);
        const img = $('#admin-img').value.trim() || 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80';
        const p = { id, title, category, lat, lon, rating: 4.0, desc: 'Added via admin', img };
        PLACES.push(p);
        renderPlaces();
        buildMarkers();
        closeModal();
        alert('Place added locally. To persist in repo, add to index.html or dataset in repository.');
      });
    }

    // Accessibility: focus outline improvements
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') document.body.classList.add('show-focus');
    });

    // Attach initial interactions for dynamically created elements
    // We need to re-attach when DOM changes (simple mutation observer)
    const mo = new MutationObserver(() => { attachCardInteractions(); updateFavUI(); });
    mo.observe(destinationsRoot, { childList: true, subtree: true });

    // Populate destinations (already created above)
    renderPlaces();

    // Small UX: open details when pressing Enter on a card
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.activeElement && document.activeElement.closest && document.activeElement.closest('.card')) {
        const id = document.activeElement.closest('.card').dataset.id;
        document.querySelector('.details-btn[data-id="' + id + '"]').click();
      }
    });

    // Show cookie banner if not set
    showCookie();

    // Announce ready
    analytics.track('page_view', { path: location.pathname });

    // Done booting
    document.body.setAttribute('aria-busy', 'false');

    // Expose some for console debugging
    window.__EXPLORE = { PLACES, addToItin, loadItin, saveItin, renderPlaces, buildMarkers };

  })();
  </script>

  <!-- Service worker skeleton (explain to user: create sw.js in repo root to enable offline caching) -->
  <!-- Example sw.js content (create file at /sw.js in repo) -->
  <!--
  self.addEventListener('install', event => {
    event.waitUntil(
      caches.open('explore-assets-v1').then(cache => cache.addAll([
        '/', '/index.html', '/manifest.json', '/styles.css'
      ]))
    );
  });
  self.addEventListener('fetch', event => {
    event.respondWith(
      caches.match(event.request).then(resp => resp || fetch(event.request))
    );
  });
  -->

</body>
</html>
