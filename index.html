<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Explore Nepal â€“ Tourist Guide</title>
  <meta name="description" content="Explore Nepal â€” guide to mountains, lakes, parks, temples, tours, and travel tips." />
  <meta name="theme-color" content="#0b67d0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="/manifest.json">
  <!-- Leaflet + MarkerCluster + Controls -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+qJb2zP0rVqjQv3Tq+Eo1t6S1VnKk6b5nYkGxkNDs=" crossorigin=""/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --primary:#0b67d0; --accent:#ff8c42; --muted:#6b7280; --glass:rgba(255,255,255,0.6);
      --radius:14px; --shadow-soft: 0 8px 30px rgba(8,15,30,0.06); --shadow-strong: 0 24px 60px rgba(2,6,23,0.15);
      --glass-border: rgba(11,103,208,0.08);
      --success:#16a34a; --danger:#ef4444; --glass-blur:10px;
      --max-width:1200px;
    }
    [data-theme="dark"]{
      --bg:#071226; --card:#081425; --muted:#9aa4b2; --primary:#3ea0ff; color:#eaf4ff; --glass:rgba(10,18,28,0.6); --glass-border: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,var(--bg),#fff);-webkit-font-smoothing:antialiased}
    a{color:inherit}
    .container{max-width:var(--max-width);margin:0 auto;padding:20px}

    /* Header */
    header.site-header{position:sticky;top:0;z-index:220;background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff;padding:10px 0;backdrop-filter:blur(6px)}
    .header-inner{display:flex;align-items:center;gap:14px;padding:8px 20px}
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
    .brand img{width:48px;height:48px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.12)}
    .brand h1{margin:0;font-size:1.05rem;font-weight:800;letter-spacing:0.2px}
    nav.main-nav{margin-left:auto;display:flex;gap:12px;align-items:center}
    nav.main-nav a{color:rgba(255,255,255,0.98);text-decoration:none;font-weight:700;padding:8px 12px;border-radius:10px;transition:background .18s,transform .12s}
    nav.main-nav a:hover{background:rgba(255,255,255,0.06);transform:translateY(-2px)}
    .search{margin-left:16px;position:relative}
    .search input{padding:10px 14px;border-radius:999px;border:none;width:300px;outline:none;box-shadow:var(--shadow-soft)}
    .mobile-toggle{display:none;background:transparent;border:none;color:#fff;font-size:1.2rem}

    /* Hero */
    .hero{display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:center;margin:22px 0;position:relative;overflow:visible}
    .hero-card{background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(255,255,255,0.9));padding:34px;border-radius:18px;box-shadow:var(--shadow-strong);border:1px solid rgba(18,38,63,0.04);transition:transform .18s}
    [data-theme="dark"] .hero-card{background:linear-gradient(180deg,rgba(10,18,28,0.92),rgba(6,12,22,0.95));border:1px solid rgba(255,255,255,0.03)}
    .hero-card:hover{transform:translateY(-6px)}
    .hero h2{margin:0 0 8px 0;font-size:1.9rem;line-height:1.05}
    .hero p{margin:0 0 14px 0;color:var(--muted);font-size:1rem}
    .cta-row{display:flex;gap:10px}
    .btn{background:var(--primary);color:#fff;padding:11px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:800;box-shadow:0 8px 24px rgba(11,103,208,0.12);transition:transform .15s,box-shadow .15s}
    .btn:hover{transform:translateY(-3px)}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(255,255,255,0.12);box-shadow:none}
    .btn.small{padding:8px 10px;font-size:.9rem;border-radius:10px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fff,#fbfdff);box-shadow:var(--shadow-soft);font-weight:700}

    .hero-decor { position:absolute; right: -40px; top: -40px; width:420px; height:420px; pointer-events:none; filter:blur(32px); opacity:0.18; mix-blend-mode:screen; }
    @keyframes floaty { 0%{transform:translateY(0) rotate(0);}50%{transform:translateY(-12px) rotate(3deg);}100%{transform:translateY(0) rotate(0);} }

    /* Controls */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:14px 0;justify-content:center}
    .filter-btns{display:flex;gap:8px;flex-wrap:wrap}
    .filter-btns button{padding:8px 12px;border-radius:10px;border:1px solid rgba(15,23,36,0.06);background:#fff;cursor:pointer;font-weight:700;transition:transform .12s}
    .filter-btns button.active{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 8px 20px rgba(255,140,66,0.12)}
    .sort-select{padding:8px;border-radius:10px;border:1px solid rgba(15,23,36,0.06);background:#fff}

    /* Grid & cards */
    .destinations{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px}
    .card{background:var(--card);border-radius:14px;border:1px solid rgba(12,20,30,0.04);overflow:hidden;display:flex;flex-direction:column;transition:transform .25s,box-shadow .25s;box-shadow:var(--shadow-soft);will-change:transform,opacity}
    .card.revealed{transform:translateY(0) scale(1); opacity:1}
    .card.hidden{transform:translateY(20px) scale(.98); opacity:0;filter:blur(.6px)}
    .card:hover{transform:translateY(-10px) scale(1.02); box-shadow:0 30px 70px rgba(8,15,30,0.12)}
    .media{height:180px;position:relative;overflow:hidden;background:linear-gradient(180deg,#e6f0ff,#fff)}
    .media img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .6s cubic-bezier(.2,.9,.2,1)}
    .card:hover .media img{transform:scale(1.08) translateY(-4px)}
    .card .info{padding:14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .rating{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(90deg,#fff,rgba(255,255,255,0.9));padding:6px 8px;border-radius:999px;font-weight:800}

    /* Map */
    .map-controls{display:flex;gap:8px;align-items:center}
    .map-legend{background:var(--card);padding:8px;border-radius:10px;box-shadow:var(--shadow-soft);border:1px solid rgba(12,20,30,0.04);font-size:.9rem}

    /* Chat */
    #chat-box{position:fixed;right:22px;bottom:22px;width:360px;background:transparent;border-radius:16px;overflow:visible;z-index:16000;transition:transform .18s}
    #chat-panel{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:14px;overflow:hidden;border:1px solid rgba(12,20,30,0.06);box-shadow:var(--shadow-strong);display:flex;flex-direction:column}
    #chat-header{display:flex;align-items:center;gap:12px;padding:12px;background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff;cursor:pointer;font-weight:800;user-select:none}
    #chat-header .avatar{width:36px;height:36px;border-radius:10px;overflow:hidden;background:rgba(255,255,255,0.12);display:inline-flex;align-items:center;justify-content:center;font-weight:800}
    #chat-messages{padding:14px;height:320px;overflow:auto;font-size:0.95rem;background:linear-gradient(180deg,rgba(250,252,255,0.9),transparent)}
    .msg{margin-bottom:10px;display:flex;gap:10px;align-items:flex-start}
    .msg.user{flex-direction:row-reverse}
    .msg .bubble{max-width:78%;padding:10px 12px;border-radius:12px;background:#f1f5f9;color:#0f1724;box-shadow:0 6px 20px rgba(8,15,30,0.04);position:relative;animation:pop .16s ease}
    .msg.user .bubble{background:linear-gradient(90deg,var(--primary),#0a8bf0);color:#fff}
    .avatar-mini{width:34px;height:34px;border-radius:8px;flex-shrink:0;overflow:hidden;display:inline-flex;align-items:center;justify-content:center;font-weight:700;background:rgba(0,0,0,0.06)}
    .msg .time {display:block;font-size:.72rem;color:var(--muted);margin-top:6px;opacity:.85}
    .typing{display:inline-block;width:56px;height:18px;border-radius:12px;background:rgba(0,0,0,0.06);position:relative}
    .typing::before,.typing::after{content:'';position:absolute;left:8px;top:6px;width:6px;height:6px;border-radius:50%;background:#cbd5e1;animation:blink 1.2s infinite}
    .typing::after{left:22px;animation-delay:.2s}
    @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
    @keyframes pop{0%{transform:scale(.98)}100%{transform:scale(1)}}

    #chat-input{display:flex;border-top:1px solid rgba(12,20,30,0.04);gap:8px;padding:10px}
    #chat-input input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(12,20,30,0.06);outline:none}
    #chat-input button{padding:10px 12px;border:none;background:var(--accent);color:#fff;border-radius:10px;cursor:pointer}
    .chat-suggests{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{background:#f3f4f6;padding:6px 10px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow-soft);font-weight:700}
    .chip:hover{transform:translateY(-3px)}

    #chat-panel.minimized{width:56px;height:56px;border-radius:999px;overflow:hidden}
    #chat-panel.minimized #chat-messages, #chat-panel.minimized #chat-input { display:none; }
    #chat-panel.minimized #chat-header{border-radius:999px;padding:12px}

    footer{background:#061026;color:#fff;padding:18px;text-align:center;margin-top:28px;border-radius:8px;box-shadow:var(--shadow-soft)}
    .credits{font-size:.9rem;color:rgba(255,255,255,0.8)}

    /* responsiveness */
    @media (max-width:980px){ .hero{grid-template-columns:1fr} .search input{width:160px} .hero-decor{display:none} }
    @media (max-width:720px){
      nav.main-nav{display:none}
      .mobile-toggle{display:inline-block}
      .search input{width:120px}
      #chat-box{right:12px;left:12px;width:auto}
      .hero{grid-template-columns:1fr}
    }

    .muted{color:var(--muted)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Lightbox */
    .lightbox { position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);z-index:20000;opacity:0;pointer-events:none;transition:opacity .18s }
    .lightbox.open { opacity:1;pointer-events:auto }
    .lightbox img { max-width:92vw;max-height:86vh;border-radius:10px;box-shadow:0 30px 80px rgba(0,0,0,0.6) }

    /* Cookie banner */
    #cookie-banner { position:fixed;left:12px;right:12px;bottom:12px;background:var(--card);padding:12px;border-radius:10px;box-shadow:var(--shadow-strong);display:flex;gap:12px;align-items:center;z-index:16000}

    /* Accessibility focus */
    :focus { outline: 3px solid rgba(11,103,208,0.18); outline-offset: 3px; border-radius: 8px; }

    /* Small helpers */
    .small{font-size:.92rem}
    .hidden-visually{position:absolute;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
    .u-row { display:flex;gap:8px;align-items:center;flex-wrap:wrap; }
    .widget { padding:12px;border-radius:8px;background:var(--card);border:1px solid rgba(12,20,30,0.04) }
  </style>

  <!-- External libs for new features -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Structured data (schema.org) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "TravelAgency",
    "name": "Explore Nepal",
    "url": "https://sanjaysubedi2063-sketch.github.io/mega-website",
    "logo": "https://raw.githubusercontent.com/sanjaysubedi2063-sketch/mega-website/18e5bf9220aae298ce739bebfa4170e6a868294a/images/logo.png",
    "description": "Local-first tourist guide to Nepal â€” curated places, itineraries and travel tools.",
    "sameAs": [
      "https://www.facebook.com/sanjay.subedi.963",
      "https://www.instagram.com/sanjaysubedi2063",
      "https://twitter.com/sanjaysubedi2063",
      "mailto:info@example.com"
    ]
  }
  </script>

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:creator" content="@sanjaysubedi2063" />
  <meta property="og:title" content="Explore Nepal â€“ Tourist Guide">
  <meta property="og:description" content="Curated travel guide across Nepal: mountains, lakes, heritage, wildlife, treks and trip planning tools.">
  <meta property="og:image" content="https://images.unsplash.com/photo-1549880338-65ddcdfd017b?w=1200&auto=format&fit=crop&q=80">
  <link rel="canonical" href="https://sanjaysubedi2063-sketch.github.io/mega-website/" />
</head>
<body data-theme="light" aria-busy="false">
  <header class="site-header" role="banner" aria-label="Top navigation">
    <div class="header-inner container">
      <div class="brand" onclick="location.href='#'">
        <img src="/images/logo.png" alt="Explore Nepal logo" onerror="this.style.display='none'">
        <h1 id="site-title">Explore Nepal ðŸ‡³ðŸ‡µ</h1>
      </div>

      <button class="mobile-toggle" aria-label="Open menu" id="mobile-toggle">â˜°</button>

      <div class="search" role="search" aria-label="Search places">
        <input id="global-search" placeholder="Search places, e.g. Pokhara, Everest..." aria-label="Search places" autocomplete="off" />
        <div id="search-suggestions" role="listbox" aria-hidden="true" style="position:absolute;top:46px;left:0;background:var(--card);box-shadow:var(--shadow-soft);border-radius:10px;overflow:hidden;display:none;min-width:260px;z-index:16000"></div>
      </div>

      <nav class="main-nav" aria-label="Main navigation">
        <a href="#about">About</a>
        <a href="#places">Places</a>
        <a href="#tours">Tours</a>
        <a href="#map">Map</a>
        <a href="#faq">FAQ</a>
        <a href="#contact">Contact</a>
      </nav>

      <div style="margin-left:12px;display:flex;gap:8px;align-items:center">
        <div id="lang-select" class="pill" title="Language selector" aria-label="Language selector"></div>
        <button id="theme-toggle" class="btn ghost" aria-pressed="false" title="Toggle theme">ðŸŒ“</button>
        <button id="view-favs" class="btn ghost" title="View favorites">â˜… <span id="fav-count">0</span></button>
      </div>
    </div>
  </header>

  <main class="container" role="main" id="main">
    <!-- HERO -->
    <section class="hero" aria-labelledby="hero-h">
      <div class="hero-card" id="hero-card">
        <h2 id="hero-h">Plan your unforgettable trip to Nepal</h2>
        <p>Hand-picked places, verified photos, local tips, flexible itineraries and live weather. Start with curated destinations or create your own route.</p>
        <div class="cta-row">
          <button class="btn" id="start-explore">Explore top places</button>
          <button class="btn ghost" id="plan-trip">Create itinerary</button>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-size:.95rem">
          <strong>Pro Tip:</strong> Use the search and filters. Click "Details" for official photos, weather, reviews and booking.
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
          <div class="pill">Local-first â€¢ Offline-ready</div>
          <div class="pill" id="hero-cta-live">Live weather â€¢ <span id="hero-temp" class="muted">â€”</span></div>
        </div>
      </div>

      <aside style="display:flex;flex-direction:column;gap:12px" aria-hidden="false">
        <div class="widget" aria-live="polite" id="weather-widget">Loading weatherâ€¦</div>
        <div class="widget" aria-label="Currency converter">
          <h4 style="margin:0 0 8px 0">Currency Converter</h4>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="cur-amount" type="number" value="1" style="padding:8px;width:80px">
            <select id="cur-from" style="padding:8px">
              <option value="USD">USD</option>
              <option value="NPR" selected>NPR</option>
              <option value="EUR">EUR</option>
              <option value="INR">INR</option>
            </select>
            <span>â†’</span>
            <select id="cur-to" style="padding:8px">
              <option value="NPR">NPR</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
            </select>
            <button id="convert-btn" class="btn small">Convert</button>
          </div>
          <div id="convert-result" class="small" style="margin-top:8px;color:var(--muted)"></div>
        </div>
        <div class="widget" id="mini-itin-widget" style="padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
          <strong>Your itinerary</strong>
          <div id="mini-itin-list" style="margin-top:8px;color:var(--muted)">No items yet</div>
        </div>
      </aside>

      <div class="hero-decor" aria-hidden="true" style="animation:floaty 8s ease-in-out infinite">
        <svg viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#0b67d0"/><stop offset="1" stop-color="#0a8bf0"/></linearGradient>
          </defs>
          <g transform="translate(-80,-80)">
            <circle cx="300" cy="300" r="180" fill="url(#g1)" opacity="0.18"/>
            <rect x="200" y="90" width="220" height="220" rx="40" fill="#ff8c42" opacity="0.06"/>
          </g>
        </svg>
      </div>
    </section>

    <!-- ABOUT -->
    <section id="about" aria-labelledby="about-h" style="margin-top:8px">
      <h2 id="about-h">Welcome to Nepal</h2>
      <p style="color:var(--muted)">Nepal is a land of dramatic landscapes, rich culture and incredible diversity. This guide helps tourists explore mountains, lakes, temples, parks and heritage sites across every region â€” with verified photos, offline-first storage, itinerary planning and simple booking capture.</p>
      <p class="small muted">This expanded release adds user profiles, saved trips, GPX/GeoJSON export, elevation preview, photo uploader (local-first), route optimization helpers and push-notification skeletons for future server integration.</p>
    </section>

    <!-- CONTROLS -->
    <section style="margin-top:12px">
      <div class="controls" role="region" aria-label="Controls for the places list">
        <div class="filter-btns" role="toolbar" aria-label="Filter places">
          <button class="active" data-filter="all">All</button>
          <button data-filter="mountains">Mountains</button>
          <button data-filter="lakes">Lakes</button>
          <button data-filter="temples">Temples</button>
          <button data-filter="heritage">Heritage</button>
          <button data-filter="wildlife">Wildlife</button>
          <button data-filter="cultural">Cultural</button>
          <button data-filter="trek">Treks</button>
        </div>

        <select id="sort-by" class="sort-select" aria-label="Sort places">
          <option value="recommended">Recommended</option>
          <option value="rating-desc">Rating: High â†’ Low</option>
          <option value="rating-asc">Rating: Low â†’ High</option>
          <option value="alpha">A â†’ Z</option>
        </select>

        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="export-itin" class="btn ghost">Export itinerary</button>
          <button class="btn" id="open-map">Open interactive map</button>
        </div>
      </div>
    </section>

    <!-- PLACES GRID -->
    <section id="places" aria-labelledby="places-h" style="margin-top:8px">
      <h2 id="places-h">Top Tourist Places</h2>
      <div class="destinations" id="destinations" aria-live="polite" role="list"></div>
      <!-- Place cards are dynamically generated via JS -->
    </section>

    <!-- NEW FEATURES: Saved Trips, Photo Upload, Export Tools, Route Optimizer, Elevation Chart -->
    <section id="advanced" aria-labelledby="advanced-h" style="margin-top:18px">
      <h2 id="advanced-h">Advanced Tools & Saved Trips</h2>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px;align-items:start">
        <div class="widget" id="saved-trips-widget">
          <h4>Saved Trips</h4>
          <div style="margin-bottom:8px">
            <input id="trip-name" placeholder="Trip name (e.g. Annapurna 7-day)" style="padding:8px;width:65%" />
            <button id="save-trip" class="btn small">Save</button>
          </div>
          <div id="saved-trips-list" class="small muted">No saved trips yet</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="load-trip" class="btn ghost small">Load selected</button>
            <button id="delete-trip" class="btn ghost small">Delete selected</button>
          </div>
        </div>

        <div class="widget" id="photo-uploader-widget">
          <h4>Upload Photos (Local preview)</h4>
          <p class="small muted">Upload photos for places from your device. Files are stored locally in the browser (base64) to preview and attach to places. Keep images small (under 1MB recommended).</p>
          <input id="photo-input" type="file" accept="image/*" multiple />
          <div id="photo-gallery" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap"></div>
        </div>

        <div class="widget" id="export-tools-widget">
          <h4>Export / Share</h4>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="export-gpx" class="btn small">Export itinerary as GPX</button>
            <button id="export-geojson" class="btn small ghost">Export as GeoJSON</button>
            <button id="share-shortlink" class="btn small ghost">Generate shareable link</button>
          </div>
          <div id="export-result" style="margin-top:8px;color:var(--muted)" class="small"></div>
        </div>

        <div class="widget" id="route-optimizer-widget">
          <h4>Route Optimizer (heuristic)</h4>
          <p class="small muted">Simple nearest-neighbour optimization to reorder itinerary for shorter travel (no routing engine required).</p>
          <div style="display:flex;gap:8px">
            <button id="optimize-route" class="btn small">Optimize</button>
            <button id="reverse-route" class="btn small ghost">Reverse</button>
          </div>
          <div style="margin-top:8px" id="route-stats" class="small muted">No route yet</div>
        </div>

        <div class="widget" id="elevation-widget">
          <h4>Elevation preview</h4>
          <p class="small muted">Synthetic elevation preview from itinerary (approximate). For production integrate an elevation API.</p>
          <canvas id="elevation-chart" height="160" style="width:100%;max-width:100%"></canvas>
          <div style="margin-top:8px" id="elevation-stats" class="small muted">No data</div>
        </div>
      </div>
    </section>

    <!-- MAP + WIDGETS -->
    <section id="map" aria-labelledby="map-h" style="margin-top:18px">
      <h2 id="map-h">Explore Nepal Map</h2>
      <div class="map-controls" style="margin-bottom:8px">
        <div class="map-legend" id="map-legend">Layers: <label><input type="checkbox" id="layer-mountains" checked> Mountains</label> <label><input type="checkbox" id="layer-lakes" checked> Lakes</label> <label><input type="checkbox" id="layer-temples" checked> Temples</label></div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="locate-me" class="btn small">Locate me</button>
          <button id="fit-itin" class="btn ghost small" title="Fit itinerary on map">Fit itinerary</button>
        </div>
      </div>
      <div class="map-container" id="map-frame" role="application" aria-label="Map of Nepal" style="height:560px;">
        <div id="leaflet-map" style="width:100%;height:100%"></div>
      </div>
      <div class="widgets" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px">
        <div class="widget">
          <h4 style="margin:0 0 8px 0">Plan ahead</h4>
          <p class="small muted">Click a place's "Details" to see official photos, weather, reviews and easy booking. Use the search & filters to find places quickly. Drag places into your itinerary to build your own route.</p>
        </div>
        <div class="widget">
          <h4 style="margin:0 0 8px 0">Nearby</h4>
          <p class="small muted">Use the "Locate me" feature to see attractions near your current location.</p>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="nearby-safari" class="btn ghost small">Nearby safaris</button>
          </div>
        </div>
        <div class="widget" id="map-stats">
          <h4 style="margin:0 0 8px 0">Map stats</h4>
          <p class="small muted" id="map-info">Loading...</p>
        </div>
      </div>
    </section>

    <!-- ITINERARY -->
    <section id="itinerary" aria-labelledby="itinerary-h" style="margin-top:18px">
      <h2 id="itinerary-h">My Itinerary</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;margin-bottom:12px">
        <div class="itinerary" id="itinerary-box" style="min-width:320px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">No items â€” add places to build a route.</div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <div class="itinerary" style="min-width:240px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
            <div style="font-weight:700">Actions</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="print-itin" class="btn">Print</button>
              <button id="share-itin" class="btn ghost">Share</button>
              <button id="clear-itin" class="btn ghost" title="Clear itinerary">Clear</button>
            </div>
          </div>
          <div class="itinerary" style="min-width:240px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,30,0.04);background:var(--card)">
            <div style="font-weight:700">Export</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="export-json" class="btn ghost small">Export JSON</button>
              <button id="export-ics" class="btn ghost small">Export .ics</button>
              <button id="import-itin" class="btn ghost small">Import JSON</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section id="faq" aria-labelledby="faq-h" style="margin-top:18px">
      <h2 id="faq-h">FAQ & Emergency</h2>
      <div style="max-width:900px;margin:0 auto">
        <details><summary>How do I get permits for trekking?</summary><p class="small muted">Popular treks require TIMS and national park permits; local agencies/trekking companies can assist with permits and logistics.</p></details>
        <details><summary>What is the best time to visit?</summary><p class="small muted">Spring (Marâ€“May) and Autumn (Sepâ€“Nov) are ideal for trekking and clear mountain views.</p></details>
        <details><summary>Emergency contacts</summary>
          <ul class="small muted">
            <li>Police (Nepal): 100</li>
            <li>Ambulance: 102</li>
            <li>Tourist Police (Kathmandu): +977-1-425xxxx (example)</li>
          </ul>
        </details>
      </div>
    </section>

    <!-- CONTACT / NEWSLETTER -->
    <section id="contact" aria-labelledby="contact-h" style="margin-top:18px">
      <h2 id="contact-h">Contact & Social Media</h2>
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:12px">
        <!-- Real inline SVG icons for social media for better control & accessibility -->
        <a href="https://www.facebook.com/sanjay.subedi.963" target="_blank" rel="noopener" title="Facebook" aria-label="Facebook">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="#1877F2" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="false">
            <path d="M22 12.07C22 6.48 17.52 2 11.93 2S1.86 6.48 1.86 12.07c0 4.99 3.65 9.13 8.44 9.92v-7.02H8.03v-2.9h2.27V9.41c0-2.24 1.33-3.48 3.36-3.48.97 0 1.99.17 1.99.17v2.18h-1.12c-1.1 0-1.44.68-1.44 1.38v1.64h2.45l-.39 2.9h-2.06v7.02c4.79-.79 8.44-4.93 8.44-9.92z" />
          </svg>
        </a>
        <a href="https://www.instagram.com/sanjaysubedi2063/?__pwa=1" target="_blank" rel="noopener" title="Instagram" aria-label="Instagram">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="#E4405F" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="false">
            <path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm5 6.5a4 4 0 100 8 4 4 0 000-8zm5.5-.75a1.125 1.125 0 11-2.25 0 1.125 1.125 0 012.25 0zM12 9.5a2.5 2.5 0 110 5 2.5 2.5 0 010-5z"/>
          </svg>
        </a>
        <a href="https://twitter.com/sanjaysubedi2063" target="_blank" rel="noopener" title="Twitter/X" aria-label="Twitter">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="#1DA1F2" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="false">
            <path d="M22 5.92c-.63.28-1.3.47-2 .56a3.47 3.47 0 001.52-1.92c-.68.4-1.44.7-2.25.86A1.73 1.73 0 0016.5 4c-1 0-1.82.82-1.82 1.82 0 .14 0 .27.02.4C11.9 6.09 9.04 4.57 6.86 2.22c-.15.26-.24.57-.24.9 0 .63.32 1.2.8 1.53-.58 0-1.12-.18-1.6-.44v.05c0 .87.62 1.6 1.44 1.76-.3.08-.6.12-.92.12-.22 0-.44-.02-.64-.06.44 1.38 1.7 2.38 3.2 2.41A3.47 3.47 0 016 13.78a4.9 4.9 0 01-1.1.14c-.28 0-.56-.02-.82-.08A6.18 6.18 0 0010.2 17c4.68 0 7.24-3.88 7.24-7.25v-.33a5.15 5.15 0 001.56-1.52z"/>
          </svg>
        </a>
        <a href="mailto:info@example.com" title="Email" aria-label="Email">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="#0a0a0a" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="false">
            <path d="M20 4H4a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
          </svg>
        </a>
      </div>

      <div style="max-width:640px;margin:12px auto;background:#fff;padding:12px;border-radius:8px;border:1px solid rgba(12,20,30,0.04)">
        <h4 style="margin-top:0">Newsletter</h4>
        <form id="newsletter">
          <input type="email" id="newsletter-email" placeholder="Your email" required style="padding:8px;width:65%"> <button class="btn" type="submit">Subscribe</button>
          <p class="small" id="newsletter-msg" style="margin:8px 0 0 0;color:var(--muted)"></p>
        </form>
      </div>
    </section>

  </main>

  <footer>
    <div class="credits">Â© 2026 Explore Nepal â€¢ Designed by Sanjay Subedi â€¢ Built with local-first data â€” add your photos to /images/ for verified visuals.</div>
  </footer>

  <!-- CHAT -->
  <div id="chat-box" aria-live="polite" aria-label="Chat with guide">
    <div id="chat-panel">
      <div id="chat-header" role="button" aria-pressed="false" tabindex="0">
        <div class="avatar">GN</div>
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:800">Guide</div>
          <div class="status" id="chat-status">Online</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="voice-toggle" class="btn ghost small" title="Voice input">ðŸŽ¤</button>
          <button id="chat-minimize" class="btn ghost small" title="Toggle">âˆ’</button>
        </div>
      </div>
      <div id="chat-messages" role="log" aria-live="polite" aria-relevant="additions"></div>
      <div style="padding:10px">
        <div class="chat-suggests" id="chat-suggests" aria-hidden="false">
          <div class="chip" data-s="#suggest_weather">Weather in Pokhara</div>
          <div class="chip" data-s="#suggest_itin">Suggest itinerary</div>
          <div class="chip" data-s="#suggest_book">Book Everest trek</div>
        </div>
        <div id="chat-input">
          <input id="user-input" placeholder="Ask about places, weather or bookings..." aria-label="Chat input">
          <button id="send-btn" aria-label="Send message">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick menu / context -->
  <div id="quick-menu" style="display:none;position:fixed;z-index:17000;background:var(--card);border-radius:10px;padding:8px;border:1px solid rgba(12,20,30,0.06);box-shadow:var(--shadow-strong)"></div>

  <!-- Modal root -->
  <div id="modal-root" aria-hidden="true" style="display:none;"></div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true" onclick="closeLightbox()"><img id="lightbox-img" src="" alt="Photo"></div>

  <!-- Offline hint -->
  <div id="offline-banner" style="display:none;position:fixed;left:0;right:0;top:56px;background:#ffcc00;padding:8px;text-align:center;z-index:15000">You are offline â€” some features may be limited.</div>

  <!-- Cookie / Consent -->
  <div id="cookie-banner" style="display:none" role="dialog" aria-live="polite">
    <div style="flex:1">
      We use local storage and optional analytics to improve the site. No external tracking by default. Accept local analytics to enable usage insights.
    </div>
    <div style="display:flex;gap:8px">
      <button id="cookie-accept" class="btn">Accept</button>
      <button id="cookie-decline" class="btn ghost">Decline</button>
    </div>
  </div>

  <!-- Service Worker Register + Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1jRk5kXQp4qf7wxiQq6l1YJQ/9tZK5QmQv5Y5rWk=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  (function () {
    'use strict';

    // --- Utilities ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function el(tag, props = {}, ...children) {
      const e = document.createElement(tag);
      for (const [k, v] of Object.entries(props)) {
        if (k.startsWith('on') && typeof v === 'function') {
          e.addEventListener(k.slice(2), v);
        } else if (k === 'class') {
          e.className = v;
        } else {
          e.setAttribute(k, String(v));
        }
      }
      for (const c of children) {
        if (c == null) continue;
        if (typeof c === 'string') e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      }
      return e;
    }

    // Simple privacy-aware analytics (local only until accepted)
    const analytics = {
      enabled: false,
      events: JSON.parse(localStorage.getItem('explore_analytics') || '[]'),
      track(name, props = {}) {
        if (!this.enabled) return;
        try {
          this.events.push({ name, props, time: new Date().toISOString() });
          localStorage.setItem('explore_analytics', JSON.stringify(this.events));
        } catch (e) { /* ignore */ }
      }
    };

    // Cookie / Consent UI
    const cookieBanner = $('#cookie-banner');
    function showCookie() {
      const seen = localStorage.getItem('explore_cookie_v1');
      if (!seen) cookieBanner.style.display = 'flex';
    }
    $('#cookie-accept').addEventListener('click', () => {
      analytics.enabled = true;
      localStorage.setItem('explore_cookie_v1', 'accepted');
      cookieBanner.style.display = 'none';
      analytics.track('cookie_accept');
    });
    $('#cookie-decline').addEventListener('click', () => {
      analytics.enabled = false;
      localStorage.setItem('explore_cookie_v1', 'declined');
      cookieBanner.style.display = 'none';
    });
    if (localStorage.getItem('explore_cookie_v1') === 'accepted') analytics.enabled = true;
    showCookie();

    // Theme
    const themeToggle = $('#theme-toggle');
    const initialTheme = localStorage.getItem('explore_theme') || 'light';
    document.body.setAttribute('data-theme', initialTheme);
    themeToggle.setAttribute('aria-pressed', String(initialTheme === 'dark'));
    themeToggle.addEventListener('click', () => {
      const theme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('explore_theme', theme);
      themeToggle.setAttribute('aria-pressed', String(theme === 'dark'));
      analytics.track('theme_toggle', { theme });
    });

    // Language selector
    const LANGS = { en: 'English', ne: 'à¤¨à¥‡à¤ªà¤¾à¤²à¥€', hi: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€', es: 'EspaÃ±ol', fr: 'FranÃ§ais' };
    const langRoot = $('#lang-select');
    let currentLang = localStorage.getItem('explore_lang') || 'en';
    function renderLangs() {
      langRoot.innerHTML = '';
      Object.entries(LANGS).forEach(([code, label]) => {
        const b = el('button', { title: label, type: 'button', onClick: () => setLang(code) }, label);
        b.style.fontWeight = code === currentLang ? '800' : '600';
        b.style.background = 'transparent';
        b.style.border = 'none';
        b.style.color = 'inherit';
        langRoot.appendChild(b);
      });
    }
    function setLang(code) {
      currentLang = code;
      localStorage.setItem('explore_lang', code);
      renderLangs();
      analytics.track('lang_change', { lang: code });
      // translations: left as exercise (localization skeleton)
    }
    renderLangs();

    // Intersection reveal
    const io = new IntersectionObserver((entries) => {
      entries.forEach(ent => {
        if (ent.isIntersecting) {
          ent.target.classList.add('revealed');
          ent.target.classList.remove('hidden');
          io.unobserve(ent.target);
        }
      });
    }, { threshold: 0.12 });

    // --- Data: curated places with real image sources (short sample; extend as needed) ---
    const PLACES = [
      {
        id: 'everest',
        title: 'Everest Base Camp',
        category: 'mountains',
        lat: 28.0043,
        lon: 86.8576,
        rating: 4.8,
        desc: 'Trek to the worldâ€™s highest peak region. Expect alpine scenery and teahouse culture.',
        img: 'https://images.unsplash.com/photo-1504198453319-5ce911bafcde?w=1600&auto=format&fit=crop&q=80',
        source: 'Unsplash / @aaronburden'
      },
      {
        id: 'phewa',
        title: 'Phewa Lake, Pokhara',
        category: 'lakes',
        lat: 28.2096,
        lon: 83.9856,
        rating: 4.6,
        desc: 'Boating, island temples and views of Annapurna.',
        img: 'https://upload.wikimedia.org/wikipedia/commons/6/6d/Phewa_Tal_%28Pokhara%29.jpg',
        source: 'Wikimedia Commons'
      },
      {
        id: 'pashupati',
        title: 'Pashupatinath Temple',
        category: 'temples',
        lat: 27.7100,
        lon: 85.3488,
        rating: 4.5,
        desc: 'One of Hinduismâ€™s most important temples, on the banks of the Bagmati River.',
        img: 'https://upload.wikimedia.org/wikipedia/commons/1/13/Pashupatinath_Temple%2C_Kathmandu_-_Nepal.jpg',
        source: 'Wikimedia Commons'
      },
      {
        id: 'chitwan',
        title: 'Chitwan National Park',
        category: 'wildlife',
        lat: 27.5389,
        lon: 84.3542,
        rating: 4.7,
        desc: 'Jungle safaris, rhinos, and rich Terai biodiversity.',
        img: 'https://images.unsplash.com/photo-1519817650390-64a93db511aa?w=1600&auto=format&fit=crop&q=80',
        source: 'Unsplash / Wildlife'
      }
      // Add more curated entries (and local images) to expand the dataset.
    ];

    // Create additional synthetic entries to demonstrate scale (sample few)
    for (let i = 1; i <= 20; i++) {
      PLACES.push({
        id: 'sample_' + i,
        title: `Sample Place ${i}`,
        category: ['mountains','lakes','temples','heritage','wildlife','trek','cultural'][i % 7],
        lat: 27.5 + (i * 0.015),
        lon: 85.1 + (i * 0.02),
        rating: (3.5 + (i % 15) * 0.1).toFixed(1),
        desc: `Sample description for place ${i}. Use /images/sample_${i}.jpg to supply a local image.`,
        img: 'https://images.unsplash.com/photo-1501785888041-af3ef285b470?w=1200&auto=format&fit=crop&q=80'
      });
    }

    // --- Local storage keys versioning ---
    const favKey = 'explore_favs_v6';
    const itinKey = 'explore_itin_v6';
    const reviewsPrefix = 'explore_reviews_v6_';
    const chatKey = 'explore_chat_v3';
    const tripsKey = 'explore_saved_trips_v1';
    const photosKey = 'explore_photos_v1';
    const profileKey = 'explore_profile_v1';

    // --- Rendering places (virtualizable) ---
    const destinationsRoot = $('#destinations');

    function createPlaceCard(p) {
      const imgSrc = `/images/${p.id}.jpg`;
      const img = el('img', { src: imgSrc, alt: p.title, loading: 'lazy' });
      // fallback on error to curated image source
      img.addEventListener('error', () => { if (!img.dataset.fallback) { img.src = p.img || (p.sourceImg || '/images/placeholder.jpg'); img.dataset.fallback = '1'; } });

      const article = el('article',
        { class: 'card hidden', 'data-id': p.id, 'data-category': p.category, 'data-lat': p.lat, 'data-lon': p.lon, role: 'listitem', draggable: true, 'aria-labelledby': p.id + '-title' },
        el('div', { class: 'media' }, img),
        el('div', { class: 'info' },
          el('h3', { id: p.id + '-title' }, p.title),
          el('p', {}, p.desc),
          el('div', { class: 'meta' },
            el('div', { class: 'actions' },
              el('button', { class: 'btn small details-btn', 'data-id': p.id, type: 'button' }, 'Details'),
              el('button', { class: 'btn small quick-fav', 'data-id': p.id, type: 'button', title: 'Favorite' }, 'â˜†'),
              el('button', { class: 'btn small', 'aria-label': 'Quick actions', 'data-id': p.id, type: 'button', onClick: (ev) => openQuickMenu(ev, p.id) }, 'â‹¯')
            ),
            el('div', { class: 'rating', title: `${p.rating} out of 5` },
              el('span', {}, 'â˜…'),
              el('strong', { class: 'rating-value', 'data-id': p.id }, String(p.rating))
            )
          )
        )
      );

      // drag support
      article.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', p.id));
      article.addEventListener('dblclick', () => addToItin(p.id));

      // reveal observer
      io.observe(article);
      return article;
    }

    // populate
    function renderPlaces(list = PLACES) {
      destinationsRoot.innerHTML = '';
      list.forEach(p => destinationsRoot.appendChild(createPlaceCard(p)));
      attachCardInteractions();
      updateFavUI();
    }
    renderPlaces();

    // --- Search with autocomplete ---
    const searchInput = $('#global-search');
    const suggestionBox = $('#search-suggestions');

    function fuzzyContains(text, q) {
      if (!q) return true;
      text = (text || '').toLowerCase(); q = q.toLowerCase();
      if (text.includes(q)) return true;
      let i = 0, j = 0;
      while (i < text.length && j < q.length) {
        if (text[i] === q[j]) j++;
        i++;
      }
      return j === q.length;
    }

    function showSuggestions(items) {
      suggestionBox.innerHTML = '';
      if (!items || items.length === 0) { suggestionBox.style.display = 'none'; suggestionBox.setAttribute('aria-hidden','true'); return; }
      items.slice(0,8).forEach(it => {
        const node = el('div', { role: 'option', tabindex: 0, class: 'suggestion-item' }, `${it.title} â€” ${it.category}`);
        node.addEventListener('click', () => { searchInput.value = it.title; filterAndSearch(); suggestionBox.style.display = 'none'; });
        node.addEventListener('keydown', e => { if (e.key === 'Enter') node.click(); });
        suggestionBox.appendChild(node);
      });
      suggestionBox.style.display = 'block'; suggestionBox.setAttribute('aria-hidden','false');
    }

    function filterAndSearch() {
      const q = (searchInput.value || '').trim().toLowerCase();
      const active = document.querySelector('.filter-btns button.active')?.dataset.filter || 'all';
      $$('#destinations .card').forEach(card => {
        const matchesFilter = active === 'all' || card.dataset.category === active;
        const text = (card.querySelector('h3')?.textContent || '') + ' ' + (card.querySelector('p')?.textContent || '') + ' ' + (card.dataset.id || '');
        const matchesSearch = q === '' || fuzzyContains(text, q);
        card.style.display = matchesFilter && matchesSearch ? 'block' : 'none';
      });
      // suggestions
      if (q.length >= 2) {
        const results = PLACES.filter(p => fuzzyContains(p.title + ' ' + p.desc + ' ' + p.category, q));
        showSuggestions(results);
      } else {
        suggestionBox.style.display = 'none';
      }
    }
    searchInput.addEventListener('input', filterAndSearch);
    searchInput.addEventListener('focus', () => { if (searchInput.value.length >= 2) filterAndSearch(); });
    document.addEventListener('click', e => { if (!$('.search').contains(e.target)) suggestionBox.style.display = 'none'; });

    // Filter buttons
    $$('.filter-btns button').forEach(btn => btn.addEventListener('click', () => {
      $$('.filter-btns button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      filterAndSearch();
      analytics.track('filter_change', { filter: btn.dataset.filter });
    }));

    // Sorting
    $('#sort-by').addEventListener('change', e => {
      const val = e.target.value;
      const parent = $('#destinations');
      const nodes = $$('#destinations .card').slice();
      nodes.sort((a, b) => {
        const ra = parseFloat(a.querySelector('.rating-value')?.textContent || 0);
        const rb = parseFloat(b.querySelector('.rating-value')?.textContent || 0);
        const ta = a.querySelector('h3')?.textContent || '';
        const tb = b.querySelector('h3')?.textContent || '';
        if (val === 'rating-desc') return rb - ra;
        if (val === 'rating-asc') return ra - rb;
        if (val === 'alpha') return ta.localeCompare(tb);
        return 0;
      });
      nodes.forEach(n => parent.appendChild(n));
      analytics.track('sort_change', { sort: val });
    });

    // Favorites
    function loadFavs() { return JSON.parse(localStorage.getItem(favKey) || '[]'); }
    function saveFavs(list) { localStorage.setItem(favKey, JSON.stringify(list)); updateFavUI(); }
    function toggleFav(id) {
      const list = loadFavs(); const idx = list.indexOf(id);
      if (idx >= 0) list.splice(idx, 1); else list.push(id);
      saveFavs(list);
      analytics.track('fav_toggle', { id, state: list.includes(id) });
    }
    function updateFavUI() {
      const list = loadFavs();
      $('#fav-count').textContent = list.length;
      $$('#destinations .card').forEach(card => {
        const id = card.dataset.id;
        const quickBtn = card.querySelector('[data-id="' + id + '"].quick-fav');
        if (quickBtn) quickBtn.textContent = list.includes(id) ? 'â˜…' : 'â˜†';
      });
    }
    document.addEventListener('click', e => {
      if (e.target.matches('.quick-fav')) { toggleFav(e.target.dataset.id); }
      if (e.target.matches('#view-favs')) {
        const list = loadFavs();
        if (list.length === 0) return alert('No favorites yet.');
        const html = '<h3>Favorites</h3><ul>' + list.map(id => {
          const c = document.querySelector('.card[data-id="' + id + '"]');
          return '<li>' + (c ? c.querySelector('h3').textContent : id) + '</li>';
        }).join('') + '</ul>';
        openModal(html);
      }
    });
    updateFavUI();

    // --- Itinerary (drag & drop + local) ---
    function loadItin() { return JSON.parse(localStorage.getItem(itinKey) || '[]'); }
    function saveItin(list) { localStorage.setItem(itinKey, JSON.stringify(list)); renderItin(); updateMiniItin(); updateMapItinerary(); updateRouteStats(); }
    function addToItin(id) {
      const list = loadItin();
      if (!list.includes(id)) { list.push(id); saveItin(list); analytics.track('itin_add', { id }); }
    }
    function renderItin() {
      const box = $('#itinerary-box'); const list = loadItin();
      if (!list || list.length === 0) { box.innerHTML = 'No items â€” add places to build an itinerary.'; return; }
      box.innerHTML = '<ol id="itin-list" style="padding-left:18px">' + list.map(id => {
        const c = document.querySelector('.card[data-id="' + id + '"]'); const title = c ? c.querySelector('h3').textContent : id;
        return `<li data-id="${id}" draggable="true" style="padding:8px;border-bottom:1px dashed rgba(0,0,0,0.05);display:flex;justify-content:space-between;align-items:center">
                <span>${title}</span>
                <span style="display:inline-flex;gap:6px"><button class="btn ghost small move-up" type="button">â†‘</button><button class="btn ghost small move-down" type="button">â†“</button><button class="btn ghost small remove-itin" type="button">âœ•</button></span>
                </li>`;
      }).join('') + '</ol>';
      attachItinHandlers();
    }
    function attachItinHandlers() {
      const listEl = $('#itin-list');
      if (!listEl) return;
      let dragSrc = null;
      listEl.querySelectorAll('li').forEach(li => {
        li.addEventListener('dragstart', e => { dragSrc = li; e.dataTransfer.effectAllowed = 'move'; li.style.opacity = 0.4; });
        li.addEventListener('dragend', () => li.style.opacity = '');
        li.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        li.addEventListener('drop', e => {
          e.preventDefault();
          if (!dragSrc || dragSrc === li) return;
          const items = loadItin(); const srcId = dragSrc.dataset.id; const dstId = li.dataset.id;
          const srcIdx = items.indexOf(srcId); const dstIdx = items.indexOf(dstId);
          if (srcIdx < 0 || dstIdx < 0) return;
          items.splice(srcIdx, 1); items.splice(dstIdx, 0, srcId); saveItin(items);
        });
      });
      listEl.querySelectorAll('.move-up').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx > 0) { items.splice(idx, 1); items.splice(idx - 1, 0, id); saveItin(items); }
      }));
      listEl.querySelectorAll('.move-down').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx >= 0 && idx < items.length - 1) { items.splice(idx, 1); items.splice(idx + 1, 0, id); saveItin(items); }
      }));
      listEl.querySelectorAll('.remove-itin').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.closest('li').dataset.id; const items = loadItin(); const idx = items.indexOf(id);
        if (idx >= 0) { items.splice(idx, 1); saveItin(items); }
      }));
    }
    // Drag from grid to itinerary (ensure re-attach after re-render)
    function attachGridDragHandlers() {
      $$('#destinations .card').forEach(card => {
        card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', card.dataset.id));
        card.addEventListener('dblclick', () => addToItin(card.dataset.id));
      });
    }
    attachGridDragHandlers();
    $('#itinerary-box').addEventListener('dragover', e => e.preventDefault());
    $('#itinerary-box').addEventListener('drop', e => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); if (id) addToItin(id); });

    renderItin();

    function updateMiniItin() {
      const mini = $('#mini-itin-list'); const list = loadItin();
      if (!list || list.length === 0) { mini.textContent = 'No items yet'; return; }
      mini.innerHTML = list.map(id => `<div>${document.querySelector('.card[data-id="${id}"] h3')?.textContent || id}</div>`).join('');
    }
    updateMiniItin();

    // Export / Import
    $('#export-json').addEventListener('click', () => {
      const data = { places: PLACES, itinerary: loadItin(), exported: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'explore-nepal-export.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('#import-itin').addEventListener('click', async () => {
      const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
      input.addEventListener('change', async () => {
        const f = input.files[0]; if (!f) return;
        const txt = await f.text();
        try {
          const parsed = JSON.parse(txt);
          if (parsed.itinerary) { saveItin(parsed.itinerary); alert('Itinerary imported'); }
          else alert('JSON does not contain itinerary');
        } catch (e) { alert('Invalid JSON'); }
      });
      input.click();
    });
    $('#export-ics').addEventListener('click', () => {
      const items = loadItin();
      let ics = 'BEGIN:VCALENDAR\\nVERSION:2.0\\nPRODID:-//ExploreNepal//EN\\n';
      items.forEach((id, idx) => {
        const title = document.querySelector('.card[data-id="' + id + '"] h3')?.textContent || id;
        const dt = new Date(); dt.setDate(dt.getDate() + idx);
        const dtstr = dt.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        ics += `BEGIN:VEVENT\\nUID:${id}@explorenepal\\nDTSTAMP:${dtstr}\\nDTSTART:${dtstr}\\nSUMMARY:${title}\\nEND:VEVENT\\n`;
      });
      ics += 'END:VCALENDAR';
      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'itinerary.ics'; a.click(); URL.revokeObjectURL(url);
    });

    // Clear itinerary
    $('#clear-itin').addEventListener('click', () => { if (confirm('Clear itinerary?')) { saveItin([]); } });

    // --- Modal & lightbox ---
    const modalRoot = $('#modal-root');
    function openModal(innerHtml) {
      modalRoot.style.display = 'block'; modalRoot.setAttribute('aria-hidden', 'false');
      modalRoot.innerHTML = '';
      const dialog = el('div', { role: 'dialog', 'aria-modal': 'true', style: 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;z-index:18000' });
      const content = el('div', { style: 'background:var(--card);border-radius:12px;padding:16px;max-width:760px;width:100%;max-height:85vh;overflow:auto;box-shadow:var(--shadow-strong)' });
      content.innerHTML = innerHtml;
      const close = el('div', { style: 'text-align:right;margin-top:12px' }, el('button', { class: 'btn ghost', type: 'button', onClick: closeModal }, 'Close'));
      content.appendChild(close);
      dialog.appendChild(content); modalRoot.appendChild(dialog);
    }
    function closeModal() { modalRoot.style.display = 'none'; modalRoot.innerHTML = ''; modalRoot.setAttribute('aria-hidden', 'true'); }
    window.openImage = (src) => {
      const lb = $('#lightbox'); const img = $('#lightbox-img');
      img.src = src; lb.classList.add('open'); lb.setAttribute('aria-hidden', 'false');
    };
    window.closeLightbox = () => { const lb = $('#lightbox'); lb.classList.remove('open'); lb.setAttribute('aria-hidden', 'true'); $('#lightbox-img').src = ''; };

    // Quick menu for cards
    const quickMenu = $('#quick-menu');
    window.openQuickMenu = (ev, id) => {
      ev.preventDefault();
      const rect = (ev.currentTarget || ev.target).getBoundingClientRect();
      quickMenu.style.top = (rect.bottom + window.scrollY + 8) + 'px';
      quickMenu.style.left = (rect.left + window.scrollX) + 'px';
      quickMenu.innerHTML = '';
      const title = (document.querySelector('.card[data-id="' + id + '"] h3')?.textContent) || id;
      quickMenu.appendChild(el('div', {}, el('div', { style: 'font-weight:800;margin-bottom:6px' }, title)));
      quickMenu.appendChild(el('button', { class: 'btn small', type: 'button', onClick: () => { addToItin(id); quickMenu.style.display = 'none'; } }, 'Add to itinerary'));
      quickMenu.appendChild(el('button', { class: 'btn small ghost', type: 'button', onClick: () => { toggleFav(id); quickMenu.style.display = 'none'; } }, 'Toggle favorite'));
      quickMenu.appendChild(el('button', { class: 'btn small ghost', type: 'button', onClick: () => { document.querySelector('.details-btn[data-id="' + id + '"]').click(); quickMenu.style.display = 'none'; } }, 'Details'));
      quickMenu.style.display = 'block';
      setTimeout(() => { document.addEventListener('click', closeQuickOnOutside, { once: true }); }, 10);
    };
    function closeQuickOnOutside(e) { if (!quickMenu.contains(e.target)) quickMenu.style.display = 'none'; }
    document.addEventListener('scroll', () => quickMenu.style.display = 'none');

    // Reviews storage
    function loadReviews(id) { return JSON.parse(localStorage.getItem(reviewsPrefix + id) || '[]'); }
    function addReview(id, rev) { const arr = loadReviews(id); arr.unshift(rev); localStorage.setItem(reviewsPrefix + id, JSON.stringify(arr)); }

    // Details & booking handling (delegated)
    document.addEventListener('click', async (e) => {
      // Details
      if (e.target.matches('.details-btn')) {
        const id = e.target.dataset.id; const card = document.querySelector('.card[data-id="' + id + '"]');
        if (!card) return;
        const title = card.querySelector('h3').textContent; const desc = card.querySelector('p').textContent;
        const lat = card.dataset.lat, lon = card.dataset.lon;
        const reviews = loadReviews(id);
        const avg = reviews.length ? (reviews.reduce((s,r)=>s+r.rating,0)/reviews.length).toFixed(1) : 'â€”';
        const reviewsHtml = reviews.length ? reviews.map(r => `<div style="border-top:1px dashed #eee;padding-top:8px"><div style="color:gold">${'â˜…'.repeat(r.rating)}</div><div>${r.text}</div><div class="small muted">${new Date(r.created).toLocaleString()}</div></div>`).join('') : '<div class="small muted">No reviews yet</div>';
        const galleryHtml = `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <img style="width:240px;height:140px;object-fit:cover;border-radius:8px;cursor:pointer" src="/images/${id}.jpg" alt="${title}" onerror="this.style.opacity=.6" onclick="openImage(this.src)">
          <img style="width:120px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer" src="${PLACES.find(p=>p.id===id)?.img || '/images/' + id + '-2.jpg'}" alt="${title} photo 2" onerror="this.style.opacity=.6" onclick="openImage(this.src)">
        </div>`;
        const html = `<h3>${title} <small style="font-weight:700;color:var(--muted)">(${avg})</small></h3><p class="muted">${desc}</p>${galleryHtml}<div id="detail-weather">Loading weather...</div><h4 style="margin-top:12px">Reviews</h4>${reviewsHtml}
          <h4 style="margin-top:12px">Add a review</h4>
          <div style="display:flex;gap:8px;align-items:center"><label>Rating</label>
          <select id="review-rating"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></div>
          <div style="margin-top:8px"><textarea id="review-text" style="width:100%;height:100px" placeholder="Tell others what you liked..."></textarea></div>
          <div style="margin-top:8px;text-align:right"><button id="submit-review" class="btn">Submit review</button> <button id="book-from-modal" class="btn ghost" data-id="${id}">Book this</button></div>`;
        openModal(html);
        if (lat && lon) fetchWeatherFor(lat, lon, document.getElementById('detail-weather'));
        // handlers attached after modal open
        setTimeout(() => {
          document.getElementById('submit-review')?.addEventListener('click', () => {
            const text = (document.getElementById('review-text').value || '').trim(); const rating = parseInt(document.getElementById('review-rating').value, 10);
            if (!text) return alert('Please add a review message.');
            addReview(id, { rating, text, created: new Date().toISOString() });
            alert('Thanks â€” your review was saved locally.');
            closeModal();
          });
          document.getElementById('book-from-modal')?.addEventListener('click', () => openBookingForm(id));
        }, 50);
      }

      // Book buttons that may be rendered dynamically
      if (e.target.matches('#book-from-modal') || e.target.matches('.book-btn')) {
        const id = e.target.dataset.id || e.target.closest('[data-id]')?.dataset?.id;
        if (id) openBookingForm(id);
      }
    });

    function openBookingForm(id) {
      const c = document.querySelector('.card[data-id="' + id + '"]'); const title = c ? c.querySelector('h3').textContent : id;
      const html = `<h3>Book: ${title}</h3>
        <form id="booking-form">
          <label style="display:block;margin-top:6px">Name</label><input id="bk-name" required style="width:100%;padding:8px;margin:6px 0">
          <label style="display:block">Email</label><input id="bk-email" type="email" required style="width:100%;padding:8px;margin:6px 0">
          <label style="display:block">Dates</label><input id="bk-dates" type="text" placeholder="e.g. 2026-03-12 to 2026-03-26" required style="width:100%;padding:8px;margin:6px 0">
          <div style="margin-top:8px;text-align:right"><button class="btn" type="submit">Send request</button></div>
        </form>`;
      openModal(html);
      document.getElementById('booking-form').addEventListener('submit', e => {
        e.preventDefault();
        const name = (document.getElementById('bk-name').value || '').trim(); const email = (document.getElementById('bk-email').value || '').trim(); const dates = (document.getElementById('bk-dates').value || '').trim();
        const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
        bookings.push({ id, name, email, dates, created: new Date().toISOString() });
        localStorage.setItem('bookings', JSON.stringify(bookings));
        alert('Booking request saved locally. We will contact you at ' + email);
        closeModal();
        analytics.track('booking_request', { id, name, email });
      });
    }

    // --- Weather: Open-Meteo (simple) ---
    async function fetchWeatherFor(lat, lon, target) {
      if (!lat || !lon) { if (target) target.textContent = 'No coordinates available.'; return; }
      try {
        if (target) target.textContent = 'Loading weather...';
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        const data = await res.json();
        if (data && data.current_weather) {
          const w = data.current_weather;
          if (target) target.innerHTML = `<strong>Current:</strong> ${w.temperature}Â°C, wind ${w.windspeed} km/h`;
          const heroTemp = $('#hero-temp'); if (heroTemp) heroTemp.textContent = `${w.temperature}Â°C`;
        } else if (target) target.textContent = 'Weather data unavailable.';
      } catch (err) {
        if (target) target.textContent = 'Failed to load weather.';
      }
    }
    fetchWeatherFor(27.7172, 85.3240, $('#weather-widget'));

    // --- Currency converter ---
    $('#convert-btn').addEventListener('click', async () => {
      const amount = Number($('#cur-amount').value) || 1; const from = $('#cur-from').value; const to = $('#cur-to').value;
      const out = $('#convert-result'); out.textContent = 'Convertingâ€¦';
      try {
        const r = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`);
        const data = await r.json();
        if (data && data.result !== undefined) out.textContent = `${amount} ${from} â‰ˆ ${data.result.toFixed(2)} ${to}`;
        else out.textContent = 'Conversion failed.';
      } catch (e) { out.textContent = 'Conversion failed.'; }
    });

    // --- Newsletter ---
    $('#newsletter').addEventListener('submit', e => {
      e.preventDefault(); const email = ($('#newsletter-email').value || '').trim();
      const subs = JSON.parse(localStorage.getItem('subs') || '[]'); subs.push({ email, created: new Date().toISOString() }); localStorage.setItem('subs', JSON.stringify(subs));
      $('#newsletter-msg').textContent = 'Thanks! Subscribed: ' + email;
      analytics.track('subscribe', { email });
    });

    // --- Chat assistant (enhanced intents) ---
    const chatMessages = $('#chat-messages'); const userInput = $('#user-input'); const sendBtn = $('#send-btn'); const chatStatus = $('#chat-status');
    let chatCollapsed = false;
    let voiceEnabled = false;
    let recognition = null;

    function loadChat() { return JSON.parse(localStorage.getItem(chatKey) || '[]'); }
    function saveChat(log) { localStorage.setItem(chatKey, JSON.stringify(log)); }
    function appendMsg(who, text, meta = {}) {
      const wrapper = el('div', { class: 'msg ' + (who === 'You' ? 'user' : 'bot') });
      const avatar = el('div', { class: 'avatar-mini' }, who === 'You' ? 'You' : 'GN');
      const bubble = el('div', { class: 'bubble' }, text);
      const time = el('div', { class: 'time' }, new Date().toLocaleTimeString());
      wrapper.appendChild(avatar);
      wrapper.appendChild(el('div', {}, bubble, time));
      chatMessages.appendChild(wrapper);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      // persist
      const log = loadChat(); log.push({ who, text, time: new Date().toISOString(), meta }); saveChat(log);
    }
    // basic command parsing
    function processUserMessage(msg) {
      const q = (msg || '').toLowerCase().trim();
      if (!q) return appendMsg('Guide', 'Please enter a question.');
      appendMsg('You', msg);
      // intents
      if (q.includes('weather in') || q.includes('weather')) {
        const place = q.replace(/weather in|what is the weather in|weather/i, '').trim();
        const p = PLACES.find(x => x.title.toLowerCase().includes(place)) || PLACES[0];
        fetchWeatherFor(p.lat, p.lon, null).then(() => appendMsg('Guide', `Fetched weather for ${p.title}. Check the details panel.`)).catch(()=>appendMsg('Guide','Could not fetch weather.'));
        return;
      }
      if (q.includes('suggest itinerary') || q.includes('suggest a trip') || q.includes('itinerary')) {
        const suggested = PLACES.slice(0,5).map(p => p.title).join(', ');
        appendMsg('Guide', `Here is a sample 5-day route: ${suggested}. Use "Add to itinerary" to save places.`);
        return;
      }
      if (q.includes('book') || q.includes('booking')) {
        appendMsg('Guide', 'I can capture a booking request for any place. Click "Details" on a place and use "Book this".');
        return;
      }
      // fallback small talk
      appendMsg('Guide', 'Thanks for your message â€” try asking about "weather in Pokhara", "suggest itinerary", or "book Everest trek".');
    }
    sendBtn.addEventListener('click', () => { processUserMessage(userInput.value); userInput.value=''; });
    userInput.addEventListener('keydown', e => { if (e.key === 'Enter') { processUserMessage(userInput.value); userInput.value=''; } });

    // Chat persists on page load
    (function hydrateChat() {
      const logs = loadChat();
      if (!logs || logs.length === 0) {
        appendMsg('Guide', 'Hello! I am your local guide. Ask me about places, weather, or itineraries.');
      } else {
        logs.forEach(l => appendMsg(l.who, l.text));
      }
    }());

    // --- Map: initialize Leaflet, cluster markers, show itinerary route ---
    let map = null;
    let markers = L.markerClusterGroup();
    let markerIndex = {};
    function initMap() {
      map = L.map('leaflet-map', { preferCanvas: true }).setView([28.2, 84.0], 7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

      markers = L.markerClusterGroup({ chunkedLoading: true });
      PLACES.forEach(p => {
        if (!p.lat || !p.lon) return;
        const marker = L.marker([p.lat, p.lon]);
        marker.bindPopup(`<strong>${p.title}</strong><div class="muted">${p.category}</div><div style="margin-top:6px"><button class="btn small" onclick="addToItin('${p.id}')">Add to itinerary</button> <button class="btn small" onclick="document.querySelector('.details-btn[data-id=\\'${p.id}\\']')?.click();">Details</button></div>`);
        marker.on('mouseover', function() { this.openPopup(); });
        markers.addLayer(marker);
        markerIndex[p.id] = marker;
      });
      map.addLayer(markers);
      updateMapItinerary();
    }
    // ensure map initializes after UI ready
    window.addEventListener('load', () => { try { initMap(); } catch (e) { console.warn('Map init failed', e); } });

    function updateMapItinerary() {
      if (!map) return;
      const items = loadItin();
      if (window.itinLayer) { try { map.removeLayer(window.itinLayer); } catch (e) {} }
      if (!items || items.length === 0) return;
      const latlngs = items.map(id => {
        const p = PLACES.find(pp => pp.id === id);
        return p ? [p.lat, p.lon] : null;
      }).filter(Boolean);
      if (latlngs.length === 0) return;
      window.itinLayer = L.polyline(latlngs, { color: '#ff8c42' }).addTo(map);
      map.fitBounds(window.itinLayer.getBounds(), { padding: [40,40] });
    }

    // --- Attach interactions after render (cards might be recreated) ---
    function attachCardInteractions() {
      $$('.details-btn').forEach(b => b.addEventListener('click', e => {
        // delegated listener handles modal content; keep this for safety
      }));
      $$('.quick-fav').forEach(b => b.addEventListener('click', e => { toggleFav(e.currentTarget.dataset.id); }));
      $$('.card').forEach(c => {
        c.addEventListener('mouseenter', () => c.classList.add('hovered'));
        c.addEventListener('mouseleave', () => c.classList.remove('hovered'));
      });
      attachGridDragHandlers();
    }

    // --- Service worker registration (offline-first) with background sync attempt ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(async reg => {
        console.info('Service worker registered', reg);
        // attempt to register sync for bookings (if supported)
        if (reg.sync) {
          try {
            await reg.sync.register('sync-bookings');
            console.info('Background sync registered: sync-bookings');
          } catch (err) { /* ignore */ }
        }
      }).catch(err => {
        console.warn('SW register failed', err);
      });
    }

    // --- Saved trips (local-first) ---
    function loadSavedTrips() { return JSON.parse(localStorage.getItem(tripsKey) || '[]'); }
    function saveSavedTrips(list) { localStorage.setItem(tripsKey, JSON.stringify(list)); }
    function renderSavedTrips() {
      const list = loadSavedTrips();
      const out = $('#saved-trips-list');
      if (!list || list.length === 0) { out.innerHTML = '<div class="small muted">No saved trips yet</div>'; return; }
      const select = el('select', { id: 'saved-trips-select', style: 'width:100%;padding:8px' });
      list.forEach((t, idx) => select.appendChild(el('option', { value: idx }, `${t.name} â€” ${t.items.length} places`)));
      out.innerHTML = ''; out.appendChild(select);
    }
    renderSavedTrips();
    $('#save-trip').addEventListener('click', () => {
      const name = ($('#trip-name').value || '').trim() || ('Trip ' + new Date().toLocaleString());
      const list = loadSavedTrips();
      list.push({ name, items: loadItin(), created: new Date().toISOString() });
      saveSavedTrips(list);
      renderSavedTrips();
      $('#trip-name').value = '';
      alert('Trip saved locally.');
    });
    $('#load-trip').addEventListener('click', () => {
      const sel = $('#saved-trips-select'); if (!sel) return alert('No saved trip selected');
      const idx = Number(sel.value); const list = loadSavedTrips(); const trip = list[idx];
      if (!trip) return alert('Trip not found');
      saveItin(trip.items || []);
      alert('Trip loaded');
    });
    $('#delete-trip').addEventListener('click', () => {
      const sel = $('#saved-trips-select'); if (!sel) return alert('No saved trip selected');
      const idx = Number(sel.value); const list = loadSavedTrips();
      if (!confirm('Delete saved trip: ' + list[idx].name + '?')) return;
      list.splice(idx,1); saveSavedTrips(list); renderSavedTrips();
    });

    // --- Photo uploader (local preview + attach to place) ---
    function loadPhotos() { return JSON.parse(localStorage.getItem(photosKey) || '[]'); }
    function savePhotos(list) { localStorage.setItem(photosKey, JSON.stringify(list)); }
    function renderPhotoGallery() {
      const photos = loadPhotos(); const gallery = $('#photo-gallery');
      gallery.innerHTML = '';
      photos.forEach((p, idx) => {
        const img = document.createElement('img'); img.src = p.data; img.style.width = '120px'; img.style.height = '80px'; img.style.objectFit = 'cover'; img.style.borderRadius = '6px'; img.alt = p.name || 'uploaded photo';
        const wrap = el('div', { style: 'position:relative;display:inline-block' }, img);
        const btn = el('button', { class: 'btn small ghost', style: 'position:absolute;right:4px;top:4px', onClick: () => { if (confirm('Remove photo?')) { photos.splice(idx,1); savePhotos(photos); renderPhotoGallery(); } } }, 'âœ•');
        wrap.appendChild(btn);
        gallery.appendChild(wrap);
      });
      if (photos.length === 0) gallery.innerHTML = '<div class="small muted">No uploaded photos</div>';
    }
    renderPhotoGallery();
    $('#photo-input').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      const photos = loadPhotos();
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        if (f.size > 2 * 1024 * 1024) {
          // try to downscale larger images to avoid blowing localStorage quota - lightweight approach
          try {
            const dataUrl = await downscaleImage(f, 1200, 0.7);
            photos.push({ name: f.name, data: dataUrl, created: new Date().toISOString() });
          } catch (err) { photos.push({ name: f.name, data: '', created: new Date().toISOString() }); }
        } else {
          const data = await fileToDataURL(f);
          photos.push({ name: f.name, data, created: new Date().toISOString() });
        }
      }
      savePhotos(photos);
      renderPhotoGallery();
      e.target.value = '';
    });
    function fileToDataURL(file) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }
    function downscaleImage(file, maxWidth = 1200, quality = 0.8) {
      return fileToDataURL(file).then(dataUrl => new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => {
          const scale = Math.min(1, maxWidth / img.width);
          const canvas = document.createElement('canvas');
          canvas.width = Math.round(img.width * scale);
          canvas.height = Math.round(img.height * scale);
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          res(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = rej; img.src = dataUrl;
      }));
    }

    // --- Export as GPX / GeoJSON / Shareable link ---
    $('#export-gpx').addEventListener('click', () => {
      const items = loadItin();
      if (!items || items.length === 0) return alert('No itinerary to export');
      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\\n<gpx version="1.1" creator="ExploreNepal">\\n<trk><name>Explore Nepal Itinerary</name><trkseg>\\n';
      items.forEach(id => {
        const p = PLACES.find(pp => pp.id === id);
        if (!p) return;
        gpx += `<trkpt lat="${p.lat}" lon="${p.lon}"><name>${escapeXml(p.title)}</name></trkpt>\\n`;
      });
      gpx += '</trkseg></trk>\\n</gpx>';
      downloadBlob(gpx, 'application/gpx+xml', 'itinerary.gpx');
    });
    $('#export-geojson').addEventListener('click', () => {
      const items = loadItin();
      if (!items || items.length === 0) return alert('No itinerary to export');
      const features = items.map(id => {
        const p = PLACES.find(pp => pp.id === id);
        if (!p) return null;
        return { type: 'Feature', properties: { id: p.id, title: p.title }, geometry: { type: 'Point', coordinates: [p.lon, p.lat] } };
      }).filter(Boolean);
      const geo = { type: 'FeatureCollection', features };
      downloadBlob(JSON.stringify(geo, null, 2), 'application/json', 'itinerary.geojson');
    });
    $('#share-shortlink').addEventListener('click', () => {
      const items = loadItin();
      if (!items || items.length === 0) return alert('No itinerary to share');
      // create a shareable short link using encoded itinerary in URL fragment (local-first, no server)
      const payload = encodeURIComponent(items.join(','));
      const href = `${location.origin}${location.pathname}#itinerary=${payload}`;
      const short = href; // for now the full link; in production call a URL shortener
      $('#export-result').textContent = short;
      navigator.clipboard?.writeText(short).then(() => alert('Shareable link copied to clipboard'));
    });
    function escapeXml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;'); }
    function downloadBlob(content, type, filename) {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // --- Route optimizer (nearest neighbour simple heuristic) ---
    $('#optimize-route').addEventListener('click', () => {
      const items = loadItin(); if (!items || items.length < 2) return alert('Need 2+ places to optimize');
      // build list of coords
      const pts = items.map(id => ({ id, p: PLACES.find(pp => pp.id === id) })).filter(Boolean);
      if (pts.length < 2) return alert('Not enough place coordinates');
      const start = pts[0];
      const ordered = [start];
      let remaining = pts.slice(1);
      while (remaining.length) {
        const last = ordered[ordered.length-1].p;
        let bestIdx = 0; let bestDist = Number.MAX_VALUE;
        remaining.forEach((r, idx) => {
          const d = haversine(last.lat, last.lon, r.p.lat, r.p.lon);
          if (d < bestDist) { bestDist = d; bestIdx = idx; }
        });
        ordered.push(remaining.splice(bestIdx,1)[0]);
      }
      const newOrder = ordered.map(o => o.id);
      saveItin(newOrder);
      alert('Optimized (nearest-neighbour) â€” review your itinerary.');
    });
    $('#reverse-route').addEventListener('click', () => {
      const items = loadItin(); items.reverse(); saveItin(items); alert('Route reversed');
    });
    function haversine(lat1, lon1, lat2, lon2) {
      function toRad(v){return v*Math.PI/180;}
      const R = 6371;
      const dLat = toRad(lat2-lat1); const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    // --- Elevation preview (synthetic) using Chart.js ---
    const elevationCtx = document.getElementById('elevation-chart')?.getContext?.('2d');
    let elevationChart = null;
    function updateElevationChart() {
      const items = loadItin();
      if (!elevationCtx) return;
      if (!items || items.length === 0) {
        $('#elevation-stats').textContent = 'No route selected';
        if (elevationChart) { elevationChart.destroy(); elevationChart = null; }
        return;
      }
      // synthetic elevation generation: base altitude by latitude/longitude pseudo-random function
      const elevations = items.map(id => {
        const p = PLACES.find(pp => pp.id === id) || { lat: 27.7, lon: 85.3 };
        // simple pseudo-elevation for visualization only
        return Math.round((Math.abs(Math.sin(p.lat) * 2000) + Math.abs(Math.cos(p.lon) * 800)));
      });
      const labels = items.map(id => (PLACES.find(pp => pp.id === id)?.title || id));
      const data = { labels, datasets: [{ label: 'Elevation (m) (approx)', data: elevations, borderColor: '#0b67d0', backgroundColor: 'rgba(11,103,208,0.08)', fill: true, tension: 0.3 }] };
      if (elevationChart) elevationChart.destroy();
      elevationChart = new Chart(elevationCtx, { type: 'line', data, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
      const min = Math.min(...elevations), max = Math.max(...elevations), avg = Math.round(elevations.reduce((a,b)=>a+b,0)/elevations.length);
      $('#elevation-stats').textContent = `Min: ${min} m â€¢ Max: ${max} m â€¢ Avg: ${avg} m`;
    }
    function updateRouteStats() {
      const items = loadItin();
      if (!items || items.length < 2) { $('#route-stats').textContent = 'Not enough points to compute stats'; updateElevationChart(); return; }
      let total = 0;
      for (let i=1;i<items.length;i++) {
        const a = PLACES.find(p=>p.id===items[i-1]); const b = PLACES.find(p=>p.id===items[i]);
        if (!a || !b) continue;
        total += haversine(a.lat, a.lon, b.lat, b.lon);
      }
      $('#route-stats').textContent = `Approx. route length: ${total.toFixed(1)} km â€¢ ${items.length} stops`;
      updateElevationChart();
    }

    // update route stats when itinerary changes
    // saveItin already calls updateRouteStats

    // --- Saved profile (local-first) ---
    function loadProfile() { return JSON.parse(localStorage.getItem(profileKey) || '{}'); }
    function saveProfile(profile) { localStorage.setItem(profileKey, JSON.stringify(profile)); }
    // small profile UI injected in header
    const profileBtn = el('button', { id: 'profile-btn', class: 'btn ghost small', title: 'Profile' }, 'Profile');
    document.querySelector('.header-inner').appendChild(profileBtn);
    profileBtn.addEventListener('click', () => {
      const profile = loadProfile();
      const html = `<h3>Your profile</h3>
        <form id="profile-form">
        <label style="display:block;margin-top:6px">Name</label><input id="pf-name" value="${profile.name || ''}" style="width:100%;padding:8px;margin:6px 0">
        <label style="display:block">Email</label><input id="pf-email" type="email" value="${profile.email || ''}" style="width:100%;padding:8px;margin:6px 0">
        <label style="display:block">Bio (public)</label><textarea id="pf-bio" style="width:100%;height:100px">${profile.bio || ''}</textarea>
        <div style="margin-top:8px;text-align:right"><button class="btn" type="submit">Save</button></div>
        </form>`;
      openModal(html);
      document.getElementById('profile-form').addEventListener('submit', e => {
        e.preventDefault();
        const name = (document.getElementById('pf-name').value || '').trim();
        const email = (document.getElementById('pf-email').value || '').trim();
        const bio = (document.getElementById('pf-bio').value || '').trim();
        saveProfile({ name, email, bio, updated: new Date().toISOString() });
        alert('Profile saved locally');
        closeModal();
      });
    });

    // --- Push notifications skeleton (request permission, example local notification) ---
    const notificationsKey = 'explore_notifications_allowed';
    async function askNotificationPermission() {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      try {
        const perm = await Notification.requestPermission();
        return perm === 'granted';
      } catch (e) { return false; }
    }
    // optional button (added to footer)
    const notifBtn = el('button', { class: 'btn small ghost', style: 'margin-left:8px' }, 'Enable notifications');
    document.querySelector('footer .credits').appendChild(notifBtn);
    notifBtn.addEventListener('click', async () => {
      const ok = await askNotificationPermission();
      localStorage.setItem(notificationsKey, String(ok));
      if (ok) new Notification('Explore Nepal', { body: 'Notifications enabled. You will receive helpful travel tips.' });
    });

    // --- Accessibility improvements: focus trap for modal (simple) ---
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeModal(); closeLightbox(); quickMenu.style.display = 'none'; }
      if (e.key === 'm') { // quick map toggle
        const mf = document.getElementById('map-frame'); if (mf) mf.scrollIntoView({ behavior: 'smooth' });
      }
    });

    // --- Small initialization actions ---
    setTimeout(() => { fetchWeatherFor(27.7172, 85.3240, $('#weather-widget')); }, 1200);
    analytics.track('page_view', { path: location.pathname });

    // --- Helpers re: URL hash hydration (load itinerary from share link) ---
    (function hydrateFromUrl() {
      const hash = location.hash || '';
      if (!hash.includes('itinerary=')) return;
      const params = new URLSearchParams(hash.replace('#',''));
      const it = params.get('itinerary');
      if (!it) return;
      const ids = decodeURIComponent(it).split(',');
      if (ids.length) { saveItin(ids); alert('Loaded itinerary from link'); }
    }());

    // --- Final attach ---
    window.addEventListener('resize', () => { if (typeof elevationChart?.resize === 'function') elevationChart.resize(); });

    // expose a couple of functions for map popups
    window.addToItin = addToItin;
    window.openQuickMenu = window.openQuickMenu;

    // Update route stats initially
    updateRouteStats();

    // Done
  })();
  </script>

  <!-- Developer guidance and notes:
       - This update added many local-first features: saved trips, image upload preview, GPX/GeoJSON export,
         simple route optimizer, synthetic elevation visualization (Chart.js), profile storage, and
         a push-notification permission helper.
       - For production:
         * Move large datasets to JSON files and fetch them (so HTML stays lightweight).
         * Use IndexedDB for large binary storage instead of localStorage (photos).
         * Add server-side components for sharing, push notifications, booking workflow and review moderation.
         * Provide a real elevation API for accurate elevation profiles (Open-Elevation, Mapbox Elevation, etc).
         * Implement proper authentication if user accounts are needed (OAuth / Email).
  -->

</body>
</html>
